<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>OS Flow â€¢ Ordem de ServiÃ§o</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/global.css">
  <link rel="stylesheet" href="css/ordem-servico.css">
</head>

<body>
  <div class="layout" id="mainLayout">
    <div class="sidebar-wrapper">
      <aside class="sidebar">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon" onclick="toggleSidebar()">OS</div>
          <div class="sidebar-logo-text">
            <h1>OS Flow</h1>
            <small>Dashboard Inteligente</small>
          </div>
        </div>

        <ul class="menu">
          <li><a href="index.html"><span class="menu-icon">ğŸ“Š</span><span class="menu-text">Dashboard</span><span class="menu-tooltip">Dashboard</span></a></li>
          <li><a href="cadastrar-clientes.html"><span class="menu-icon">ğŸ‘¥</span><span class="menu-text">Clientes</span><span class="menu-tooltip">Clientes</span></a></li>
          <li><a href="produtos.html"><span class="menu-icon">ğŸ“¦</span><span class="menu-text">Produtos</span><span class="menu-tooltip">Produtos</span></a></li>
          <li><a href="servicos.html"><span class="menu-icon">ğŸ”§</span><span class="menu-text">ServiÃ§os</span><span class="menu-tooltip">ServiÃ§os</span></a></li>
          <li><a href="vendas.html"><span class="menu-icon">ğŸ’°</span><span class="menu-text">Vendas</span><span class="menu-tooltip">Vendas</span></a></li>
          <li><a href="ordem-servico.html" class="active"><span class="menu-icon">ğŸ“‹</span><span class="menu-text">Ordens</span><span class="menu-tooltip">Ordens</span></a></li>
          <li><a href="garantias.html"><span class="menu-icon">ğŸ›¡ï¸</span><span class="menu-text">Garantias</span><span class="menu-tooltip">Garantias</span></a></li>
          <li><a href="arquivos.html"><span class="menu-icon">ğŸ“</span><span class="menu-text">Arquivos</span><span class="menu-tooltip">Arquivos</span></a></li>
          <li><a href="financeiro.html"><span class="menu-icon">ğŸ’³</span><span class="menu-text">Financeiro</span><span class="menu-tooltip">Financeiro</span></a></li>
          <li><a href="cobranca.html"><span class="menu-icon">ğŸ“„</span><span class="menu-text">CobranÃ§a</span><span class="menu-tooltip">CobranÃ§a</span></a></li>
          <li><a href="configuracoes.html"><span class="menu-icon">âš™ï¸</span><span class="menu-text">ConfiguraÃ§Ãµes</span><span class="menu-tooltip">ConfiguraÃ§Ãµes</span></a></li>
        </ul>

        <div class="sidebar-footer">v3.8.1 â€¢ Â© <span id="ano-atual"></span> â€¢ OS Flow</div>
      </aside>
    </div>

    <div class="main-wrapper">
      <header class="topbar">
        <div class="topbar-title">
          Ordem de ServiÃ§o
          <div class="breadcrumb"><span>Status: Recebido â†’ DiagnÃ³stico â†’ Em reparo â†’ Aguardando buscar â†’ Pronto</span></div>
        </div>
        <div class="user-info">
          <span>Bem-vindo, <strong id="topUserName">UsuÃ¡rio</strong></span>
          <div class="user-avatar" id="topUserAvatar">U</div>
        </div>
      </header>

      <main class="content">
        <div class="page-header">
          <h1>Ordens de ServiÃ§o</h1>
          <div class="actions">
            <button class="btn" type="button" onclick="resetCriacao()">ğŸ†• Nova OS</button>
            <a class="btn" href="configuracoes.html" target="_blank" rel="noopener">âš™ï¸ Tipos/Checklist</a>
          </div>
        </div>

        <section class="panel">
          <div class="panel-title">ğŸ‘¥ Criar OS (dados do cliente)</div>

          <div class="section-help">
            Fluxo: crie a OS com o <strong>cliente</strong>. Depois, na lista, clique em <strong>Editar</strong> para preencher
            equipamento (tipo cadastrado em ConfiguraÃ§Ãµes), dinÃ¢micos, checklist, produtos/serviÃ§os e faturar.
          </div>

          <form id="osCreateForm" onsubmit="criarOSBasica(event)">
            <div class="form-row">
              <div class="field">
                <label for="clienteSelect">Cliente cadastrado</label>
                <select id="clienteSelect" onchange="onClienteSelecionado()">
                  <option value="">Selecionar...</option>
                </select>
                <div class="hint">Puxa do cadastro.</div>
              </div>

              <div class="field">
                <label for="clienteNome">Nome do cliente (snapshot)</label>
                <input id="clienteNome" placeholder="Digite o nome do cliente" required />
              </div>
            </div>

            <div class="form-row">
              <div class="field">
                <label for="clienteTelefone">Telefone</label>
                <input id="clienteTelefone" placeholder="(11) 99999-9999" />
              </div>

              <div class="field">
                <label for="clienteEmail">E-mail</label>
                <input id="clienteEmail" placeholder="cliente@email.com" />
              </div>
            </div>

            <div class="actions">
              <button class="btn btn-primary" type="submit">ğŸ’¾ Salvar e criar OS</button>
            </div>
          </form>
        </section>

        <section class="panel">
          <div class="panel-title">ğŸ“š OS criadas</div>

          <div class="form-row">
            <div class="field" style="margin-bottom:0;">
              <label for="buscarOS">Buscar</label>
              <input id="buscarOS" placeholder="Buscar por nÃºmero ou cliente..." oninput="renderListaOS()" />
            </div>
            <div class="field" style="margin-bottom:0;">
              <label for="filtroStatus">Status</label>
              <select id="filtroStatus" onchange="renderListaOS()">
                <option value="">Todos</option>
                <option value="recebido">Recebido</option>
                <option value="diagnostico">DiagnÃ³stico</option>
                <option value="reparo">Em reparo</option>
                <option value="aguardando_buscar">Aguardando cliente buscar</option>
                <option value="pronto">Pronto</option>
                <option value="finalizada">Finalizada</option>
              </select>
            </div>
          </div>

          <div style="overflow:auto; margin-top: var(--space-4);">
            <table class="table" aria-label="Lista de OS" id="osTable">
              <thead>
                <tr>
                  <th>NÂº OS</th>
                  <th>Cliente</th>
                  <th>Status</th>
                  <th>Faturamento</th>
                  <th style="text-align:right;">Total</th>
                  <th>Criada em</th>
                  <th style="width: 340px;">AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="osList"></tbody>
            </table>
          </div>

          <div id="emptyOS" class="empty" style="display:none; margin-top: var(--space-4);">
            Nenhuma OS criada ainda. Use o formulÃ¡rio acima para criar a primeira.
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- MODAL EDITAR OS -->
  <div class="modal-backdrop" id="modalEditarOS">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalEditarTitulo">Editar OS</h3>
        <button class="modal-close" type="button" onclick="fecharModalEditar()">Ã—</button>
      </div>

      <div class="tabs" role="tablist" aria-label="Abas de ediÃ§Ã£o da OS">
        <button class="tab active" type="button" onclick="selectTab('tab-geral')" id="btn-tab-geral">Geral</button>
        <button class="tab" type="button" onclick="selectTab('tab-equipamento')" id="btn-tab-equipamento">Equipamento</button>
        <button class="tab" type="button" onclick="selectTab('tab-dinamicos')" id="btn-tab-dinamicos">DinÃ¢micos</button>
        <button class="tab" type="button" onclick="selectTab('tab-checklist')" id="btn-tab-checklist">Checklist</button>
        <button class="tab" type="button" onclick="selectTab('tab-anexos')" id="btn-tab-anexos">Anexos</button>
        <button class="tab" type="button" onclick="selectTab('tab-produtos')" id="btn-tab-produtos">Produtos</button>
        <button class="tab" type="button" onclick="selectTab('tab-servicos')" id="btn-tab-servicos">ServiÃ§os</button>
        <button class="tab" type="button" onclick="selectTab('tab-faturamento')" id="btn-tab-faturamento">Faturar</button>
        <button class="tab" type="button" onclick="selectTab('tab-termo')" id="btn-tab-termo">Garantia</button>
      </div>

      <form id="osEditForm" onsubmit="salvarDetalhesOS(event)">
        <!-- Geral -->
        <div class="tab-pane active" id="tab-geral" role="tabpanel" aria-labelledby="btn-tab-geral">
          <div class="panel-title" style="margin-top:0;">ğŸ“Œ Controle</div>

          <div class="form-row">
            <div class="field">
              <label for="editNumeroOS">NÃºmero OS</label>
              <input id="editNumeroOS" readonly />
              <div class="hint">Gerado automaticamente na criaÃ§Ã£o.</div>
            </div>

            <div class="field">
              <label for="editStatus">Status</label>
              <select id="editStatus">
                <option value="recebido">Recebido</option>
                <option value="diagnostico">DiagnÃ³stico</option>
                <option value="reparo">Em reparo</option>
                <option value="aguardando_buscar">Aguardando cliente buscar</option>
                <option value="pronto">Pronto</option>
                <option value="finalizada">Finalizada</option>
              </select>
              <div class="hint">Finalizada = cancelada / cliente desistiu / sem serviÃ§o.</div>
            </div>
          </div>

          <div class="panel-title">ğŸ§  Defeito / DiagnÃ³stico</div>

          <div class="field">
            <label for="editDefeitoRelatado">Defeito relatado</label>
            <textarea id="editDefeitoRelatado" placeholder="O que o cliente informou"></textarea>
          </div>

          <div class="field">
            <label for="editDiagnostico">DiagnÃ³stico tÃ©cnico</label>
            <textarea id="editDiagnostico" placeholder="AnÃ¡lise do tÃ©cnico"></textarea>
          </div>

          <div class="panel-title">ğŸ“ ObservaÃ§Ãµes gerais</div>
          <div class="field">
            <label for="editObsGeral">ObservaÃ§Ãµes</label>
            <textarea id="editObsGeral" placeholder="ObservaÃ§Ãµes internas"></textarea>
          </div>
        </div>

        <!-- Equipamento -->
        <div class="tab-pane" id="tab-equipamento" role="tabpanel" aria-labelledby="btn-tab-equipamento">
          <div class="panel-title">ğŸ“± Equipamento</div>

          <div class="section-help">
            Os tipos e campos dinÃ¢micos vÃªm de <strong>ConfiguraÃ§Ãµes â†’ Tipos de Equipamento</strong>.
          </div>

          <div class="form-row">
            <div class="field">
              <label for="editTipoEquipamento">Tipo</label>
              <select id="editTipoEquipamento" onchange="onModalTipoEquipamentoChange()">
                <option value="">Carregando...</option>
              </select>
              <div class="hint">A lista Ã© controlada pelo ConfiguraÃ§Ãµes (dinÃ¢micos).</div>
            </div>

            <div class="field">
              <label for="editMarcaModelo">Marca / Modelo</label>
              <input id="editMarcaModelo" placeholder="Ex: iPhone 14 / Dell XPS / Samsung UN50..." />
            </div>
          </div>

          <div class="form-row">
            <div class="field">
              <label for="editSerial">Serial / IMEI</label>
              <input id="editSerial" placeholder="Opcional" />
            </div>

            <div class="field">
              <label for="editSenha">Senha (se houver)</label>
              <input id="editSenha" placeholder="Opcional" />
            </div>
          </div>

          <div class="field">
            <label for="editAcessorios">AcessÃ³rios entregues</label>
            <input id="editAcessorios" placeholder="carregador, cabo, controle..." />
          </div>

          <div class="field">
            <label for="editEstadoFisico">Estado fÃ­sico</label>
            <textarea id="editEstadoFisico" placeholder="Riscos, trincas, manchas..."></textarea>
          </div>
        </div>

        <!-- DinÃ¢micos -->
        <div class="tab-pane" id="tab-dinamicos">
          <div class="panel-title">ğŸ§© Campos DinÃ¢micos do Equipamento</div>
          <div class="section-help">
            Esses campos sÃ£o definidos em <strong>ConfiguraÃ§Ãµes</strong>. Eles aparecem conforme o tipo selecionado.
          </div>

          <div id="dinamicosSlot" class="empty">Selecione o tipo do equipamento.</div>
        </div>

        <!-- Checklist -->
        <div class="tab-pane" id="tab-checklist">
          <div class="panel-title">âœ… Checklist de Recebimento</div>
          <div class="section-help">Checklist definido em ConfiguraÃ§Ãµes por tipo.</div>
          <div id="checklistSlot" class="empty">Selecione o tipo do equipamento.</div>
        </div>

        <!-- Anexos -->
        <div class="tab-pane" id="tab-anexos">
          <div class="panel-title">ğŸ“ Anexos / Fotos / VÃ­deos</div>
          <div class="section-help">
            IntegraÃ§Ã£o com <strong>arquivos.html</strong> (pasta por OS). Para anexar, use a pÃ¡gina Arquivos e selecione a OS.
          </div>

          <div class="form-row">
            <div class="field">
              <label for="editAnexosGroupKey">Chave de grupo</label>
              <input id="editAnexosGroupKey" placeholder="osflow:files:os|<osId>" readonly />
            </div>
            <div class="field">
              <label for="editAnexosIds">IDs vinculados</label>
              <input id="editAnexosIds" placeholder="id1,id2,id3" readonly />
            </div>
          </div>

          <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
            <button class="btn" type="button" onclick="window.open('arquivos.html', '_blank')">ğŸ“ Abrir Arquivos</button>
          </div>
        </div>

        <!-- Produtos -->
        <div class="tab-pane" id="tab-produtos">
          <div class="panel-title">ğŸ“¦ Produtos (estoque) na OS</div>
          <div class="section-help">Gera valores. Baixa estoque apenas ao pagar (ou pagar agora no faturamento).</div>

          <div class="split-row">
            <div class="field" style="margin-bottom:0;">
              <label for="buscarProduto">Buscar produto</label>
              <input id="buscarProduto" placeholder="Nome, cÃ³digo..." oninput="renderProdutosBusca()" />
            </div>
            <div class="field" style="margin-bottom:0;">
              <label>AÃ§Ãµes</label>
              <div class="inline-actions">
                <button class="btn" type="button" onclick="renderProdutosBusca()">ğŸ” Buscar</button>
                <button class="btn" type="button" onclick="limparBuscaProduto()">ğŸ§¹ Limpar</button>
              </div>
            </div>
          </div>

          <div style="overflow:auto; margin-top: var(--space-4);">
            <table class="table">
              <thead>
                <tr>
                  <th>Produto</th>
                  <th>Estoque</th>
                  <th style="text-align:right;">PreÃ§o</th>
                  <th style="width:160px;">Qtd</th>
                  <th style="width:120px;">AÃ§Ã£o</th>
                </tr>
              </thead>
              <tbody id="produtoBuscaTbody"></tbody>
            </table>
          </div>

          <div class="panel-title" style="margin-top: var(--space-8);">ğŸ›’ Itens na OS</div>
          <div style="overflow:auto;">
            <table class="table">
              <thead>
                <tr>
                  <th>Item</th>
                  <th style="text-align:right;">PreÃ§o</th>
                  <th style="text-align:center;">Qtd</th>
                  <th style="text-align:right;">Subtotal</th>
                  <th style="width:120px;">AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="osProdutosTbody"></tbody>
            </table>
          </div>
          <div id="osProdutosEmpty" class="empty" style="display:none; margin-top: var(--space-4);">
            Nenhum produto adicionado nesta OS.
          </div>
        </div>

        <!-- ServiÃ§os -->
        <div class="tab-pane" id="tab-servicos">
          <div class="panel-title">ğŸ”§ ServiÃ§os (cadastrados) na OS</div>
          <div class="section-help">ServiÃ§os disponÃ­veis vÃªm do cadastro de serviÃ§os.</div>

          <div class="split-row">
            <div class="field" style="margin-bottom:0;">
              <label for="buscarServico">Buscar serviÃ§o</label>
              <input id="buscarServico" placeholder="Nome..." oninput="renderServicosBusca()" />
            </div>
            <div class="field" style="margin-bottom:0;">
              <label>AÃ§Ãµes</label>
              <div class="inline-actions">
                <button class="btn" type="button" onclick="renderServicosBusca()">ğŸ” Buscar</button>
                <button class="btn" type="button" onclick="limparBuscaServico()">ğŸ§¹ Limpar</button>
              </div>
            </div>
          </div>

          <div style="overflow:auto; margin-top: var(--space-4);">
            <table class="table">
              <thead>
                <tr>
                  <th>ServiÃ§o</th>
                  <th style="text-align:right;">Valor</th>
                  <th style="width:120px;">AÃ§Ã£o</th>
                </tr>
              </thead>
              <tbody id="servicoBuscaTbody"></tbody>
            </table>
          </div>

          <div class="panel-title" style="margin-top: var(--space-8);">ğŸ“Œ ServiÃ§os anexados</div>
          <div style="overflow:auto;">
            <table class="table">
              <thead>
                <tr>
                  <th>ServiÃ§o</th>
                  <th style="text-align:right;">Valor</th>
                  <th style="width:120px;">AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="osServicosTbody"></tbody>
            </table>
          </div>
          <div id="osServicosEmpty" class="empty" style="display:none; margin-top: var(--space-4);">
            Nenhum serviÃ§o anexado nesta OS.
          </div>
        </div>

        <!-- Faturamento -->
        <div class="tab-pane" id="tab-faturamento">
          <div class="panel-title">ğŸ’³ Faturamento</div>
          <div class="section-help">Pagar agora baixa estoque. Gerar cobranÃ§a nÃ£o baixa estoque (baixa somente quando marcar como paga em CobranÃ§a).</div>

          <div class="split-row">
            <div class="kpi-box">
              <div class="kpi-label">Subtotal produtos</div>
              <div class="kpi-value money" id="kpiSubProdutos">R$ 0,00</div>
            </div>
            <div class="kpi-box">
              <div class="kpi-label">Subtotal serviÃ§os</div>
              <div class="kpi-value money" id="kpiSubServicos">R$ 0,00</div>
            </div>
            <div class="kpi-box">
              <div class="kpi-label">Desconto</div>
              <div class="kpi-value money" id="kpiDesconto">R$ 0,00</div>
            </div>
            <div class="kpi-box">
              <div class="kpi-label">Total</div>
              <div class="kpi-value money" id="kpiTotal">R$ 0,00</div>
            </div>
          </div>

          <div class="panel-title" style="margin-top: var(--space-8);">Ajustes</div>

          <div class="form-row">
            <div class="field">
              <label for="editDesconto">Desconto (R$)</label>
              <input id="editDesconto" type="number" min="0" step="0.01" value="0" oninput="updateFinanceKPIs()" />
            </div>
            <div class="field">
              <label for="editFormaPagamento">Forma de pagamento (preferÃªncia)</label>
              <select id="editFormaPagamento">
                <option value="dinheiro">Dinheiro</option>
                <option value="pix">PIX</option>
                <option value="cartao">CartÃ£o</option>
                <option value="boleto">Boleto</option>
                <option value="transferencia">TransferÃªncia</option>
                <option value="outro">Outro</option>
              </select>
            </div>
          </div>

          <div class="panel-title">Status do faturamento</div>
          <div style="display:flex; gap: var(--space-2); flex-wrap:wrap; align-items:center;">
            <span class="pill" id="pillFaturamento">NÃ£o faturada</span>
            <span class="hint" id="hintFaturamento"></span>
          </div>

          <div class="modal-actions">
            <button class="btn btn-warning" type="button" onclick="abrirModalFaturamento()">ğŸ§¾ Faturar OS</button>
          </div>
        </div>

        <!-- Termo -->
        <div class="tab-pane" id="tab-termo">
          <div class="panel-title">ğŸ§¾ Garantia / Termo</div>
          <div class="section-help">Esta parte pode ser integrada depois com garantias.html.</div>

          <div class="form-row">
            <div class="field">
              <label for="editTermo">Selecionar garantia</label>
              <select id="editTermo" onchange="renderPreviewTermo()">
                <option value="30">PadrÃ£o 30 dias</option>
                <option value="90">PadrÃ£o 90 dias</option>
                <option value="0">Sem garantia</option>
              </select>
            </div>

            <div class="field">
              <label for="editTermoObs">ObservaÃ§Ãµes do termo</label>
              <input id="editTermoObs" placeholder="Opcional" oninput="renderPreviewTermo()" />
            </div>
          </div>

          <div id="previewTermo" class="empty" style="text-align:left;">
            Preview do termo.
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn" type="button" onclick="fecharModalEditar()">Cancelar</button>
          <button class="btn btn-success" type="submit">ğŸ’¾ Salvar detalhes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL: Escolha de faturamento -->
  <div class="modal-backdrop" id="modalFaturamento">
    <div class="modal" style="width: 720px;">
      <div class="modal-header">
        <h3>ğŸ§¾ Faturar OS</h3>
        <button class="modal-close" type="button" onclick="fecharModalFaturamento()">Ã—</button>
      </div>

      <div class="section-help" id="faturamentoResumo"></div>

      <div class="fulfillment">
        <div class="fulfillment-title">Como finalizar</div>

        <label class="radio-row" for="osOptPayNow">
          <input type="radio" name="osFulfillment" id="osOptPayNow" value="pay_now" checked />
          <div>
            <strong>Pagar agora</strong>
            <small>Marca a OS como <b>faturada</b> e dÃ¡ baixa no estoque imediatamente.</small>
          </div>
        </label>

        <label class="radio-row" for="osOptCharge">
          <input type="radio" name="osFulfillment" id="osOptCharge" value="charge" />
          <div>
            <strong>Gerar cobranÃ§a</strong>
            <small>Cria cobranÃ§a em <b>cobranca.html</b> e deixa a OS como <b>aguardando pagamento</b>. Sem baixa no estoque atÃ© pagar.</small>
          </div>
        </label>
      </div>

      <div class="modal-actions">
        <button class="btn" type="button" onclick="fecharModalFaturamento()">Cancelar</button>
        <button class="btn btn-primary" type="button" onclick="confirmarFaturamento()">Confirmar</button>
      </div>
    </div>
  </div>
  <script src="js/ordem-servico.js"></script>
</body>
</html>