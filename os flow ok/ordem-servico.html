<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>OS Flow ‚Ä¢ Ordem de Servi√ßo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-50:#f0f9ff; --primary-100:#e0f2fe; --primary-200:#bae6fd; --primary-300:#7dd3fc;
      --primary-400:#38bdf8; --primary-500:#0ea5e9; --primary-600:#0284c7; --primary-700:#0369a1;
      --success:#10b981; --success-light:#d1fae5;
      --warning:#f59e0b; --warning-light:#fef3c7;
      --danger:#ef4444; --danger-light:#fee2e2;
      --purple:#8b5cf6; --teal:#14b8a6;

      --gray-50:#f9fafb; --gray-100:#f3f4f6; --gray-200:#e5e7eb; --gray-300:#d1d5db;
      --gray-400:#9ca3af; --gray-500:#6b7280; --gray-600:#4b5563; --gray-700:#374151;
      --gray-800:#1f2937; --gray-900:#111827;

      --bg-body: linear-gradient(135deg, #f8fafc 0%, #f0f9ff 100%);
      --bg-surface:#ffffff;
      --bg-sidebar: rgba(255,255,255,0.95);

      --text-primary:#111827;
      --text-secondary:#4b5563;
      --text-tertiary:#6b7280;
      --text-muted:#9ca3af;
      --text-inverse:#ffffff;

      --border-light:#e5e7eb;
      --border-medium:#d1d5db;

      --shadow-sm: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --shadow-2xl: 0 25px 50px -12px rgba(0,0,0,0.25);
      --shadow-primary: 0 4px 14px 0 rgba(14,165,233,0.2);

      --font-primary:'Plus Jakarta Sans', system-ui, -apple-system, sans-serif;
      --font-secondary:'Manrope', system-ui, -apple-system, sans-serif;

      --space-1:.25rem; --space-2:.5rem; --space-3:.75rem; --space-4:1rem; --space-5:1.25rem; --space-6:1.5rem; --space-8:2rem; --space-10:2.5rem; --space-12:3rem;

      --radius-sm:.375rem; --radius-md:.5rem; --radius-lg:.75rem; --radius-xl:1rem; --radius-full:9999px;

      --transition-fast:150ms cubic-bezier(0.4,0,0.2,1);
      --transition-base:250ms cubic-bezier(0.4,0,0.2,1);

      --sidebar-width: 260px;
      --sidebar-collapsed: 72px;
    }

    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family: var(--font-secondary);
      background: var(--bg-body);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.5;
    }

    .layout { display:grid; grid-template-columns: var(--sidebar-width) 1fr; min-height:100vh; transition: grid-template-columns var(--transition-base); }
    .layout.collapsed { grid-template-columns: var(--sidebar-collapsed) 1fr; }

    .sidebar-wrapper {
      position: sticky; top:0; height:100vh;
      background: var(--bg-sidebar);
      border-right:1px solid var(--border-light);
      box-shadow: var(--shadow-md);
      z-index:100;
      width: var(--sidebar-width);
      transition: all var(--transition-base);
      overflow:hidden;
    }
    .layout.collapsed .sidebar-wrapper { width: var(--sidebar-collapsed); }

    .sidebar { padding: var(--space-6) 0; display:flex; flex-direction:column; height:100%; }

    .sidebar-logo {
      padding:0 var(--space-4) var(--space-6);
      display:flex; align-items:center; gap: var(--space-3);
      border-bottom:1px solid var(--border-light);
      padding-bottom: var(--space-6);
      margin-bottom: var(--space-6);
      min-height: 60px;
    }
    .layout.collapsed .sidebar-logo { padding:0 var(--space-3) var(--space-6); justify-content:center; }

    .sidebar-logo-icon {
      width:40px; height:40px; border-radius: var(--radius-lg);
      background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
      display:flex; align-items:center; justify-content:center;
      color: var(--text-inverse);
      font-family: var(--font-primary);
      font-weight:800;
      box-shadow: var(--shadow-primary);
      cursor:pointer;
      transition: transform var(--transition-base);
      flex-shrink: 0;
    }
    .sidebar-logo-icon:hover { transform: scale(1.05); }

    .sidebar-logo-text { overflow:hidden; transition: opacity var(--transition-base), max-width var(--transition-base); max-width: 200px; }
    .layout.collapsed .sidebar-logo-text { opacity:0; max-width: 0; }

    .sidebar-logo-text h1 { font-family: var(--font-primary); font-size:1.25rem; font-weight:800; letter-spacing:-0.5px; white-space:nowrap; }
    .sidebar-logo-text small { display:block; font-size:0.6875rem; color: var(--text-tertiary); margin-top: var(--space-1); font-weight:600; white-space:nowrap; }

    .menu { list-style:none; padding:0 var(--space-2); flex:1; font-size: 0.875rem; }
    .layout.collapsed .menu { padding:0 var(--space-1); }
    .menu li { margin-bottom: var(--space-1); }

    .menu a {
      display:flex; align-items:center; gap: var(--space-3);
      padding: var(--space-3);
      color: var(--text-secondary);
      text-decoration:none;
      border-radius: var(--radius-lg);
      transition: all var(--transition-base);
      white-space: nowrap;
      position: relative;
    }

    .layout.collapsed .menu a { justify-content:center; }
    .menu a:hover { background: var(--primary-50); color: var(--primary-600); transform: translateX(4px); }
    .layout.collapsed .menu a:hover { transform: translateX(0) scale(1.05); }
    .menu a.active { background: var(--primary-500); color: var(--text-inverse); box-shadow: var(--shadow-primary); font-weight: 800; }

    .menu-icon { width:20px; text-align:center; font-size:1.125rem; flex-shrink:0; }
    .menu-text { overflow:hidden; transition: opacity var(--transition-base), max-width var(--transition-base); max-width:200px; }
    .layout.collapsed .menu-text { opacity:0; max-width:0; }

    .menu-tooltip {
      position:absolute; left:100%; top:50%; transform: translateY(-50%);
      background: var(--gray-800); color:#fff;
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-md);
      font-size: 0.75rem;
      font-weight: 600;
      opacity:0; visibility:hidden; transition: all var(--transition-fast);
      pointer-events:none; box-shadow: var(--shadow-md);
      white-space: nowrap;
      z-index: 1000;
    }
    .layout.collapsed .menu a:hover .menu-tooltip { opacity:1; visibility:visible; transform: translateY(-50%) translateX(8px); }

    .sidebar-footer {
      padding: var(--space-3) var(--space-4);
      font-size: 0.6875rem;
      color: var(--text-muted);
      border-top: 1px solid var(--border-light);
      font-weight: 600;
      text-align:center;
      white-space: nowrap;
      overflow:hidden;
    }

    .main-wrapper { display:flex; flex-direction:column; min-width:0; }
    .topbar {
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border-light);
      padding: var(--space-3) var(--space-6);
      display:flex; align-items:center; justify-content: space-between;
      position: sticky; top:0; z-index:90;
      box-shadow: var(--shadow-sm);
      min-height: 60px;
    }

    .topbar-title {
      font-family: var(--font-primary);
      font-size: 1.25rem;
      font-weight: 800;
      letter-spacing: -0.5px;
      display:flex; align-items:center; gap: var(--space-3);
    }

    .breadcrumb {
      font-size: 0.6875rem;
      color: var(--text-tertiary);
      font-weight: 600;
      display:flex; align-items:center; gap: var(--space-2);
    }
    .breadcrumb::before { content:'|'; color: var(--border-medium); margin-right: var(--space-2); font-weight: 400; }
    .breadcrumb span {
      background: var(--primary-500);
      color: var(--text-inverse);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-full);
      font-size:0.625rem;
      letter-spacing:.5px;
      text-transform:uppercase;
      font-weight: 800;
    }

    .user-info { display:flex; align-items:center; gap: var(--space-3); font-size: 0.8125rem; color: var(--text-secondary); font-weight: 600; }
    .user-avatar {
      width:36px; height:36px; border-radius: var(--radius-full);
      background: linear-gradient(135deg, var(--primary-500) 0%, var(--teal) 100%);
      display:flex; align-items:center; justify-content:center;
      color: var(--text-inverse);
      font-weight: 800;
      box-shadow: var(--shadow-sm);
      cursor:pointer;
    }

    .content { padding: var(--space-6); flex:1; }

    .page-header {
      display:flex; justify-content: space-between; align-items:center;
      margin-bottom: var(--space-8);
      gap: var(--space-4);
      flex-wrap: wrap;
    }
    .page-header h1 {
      font-family: var(--font-primary);
      font-size: 1.75rem;
      font-weight: 900;
      letter-spacing: -0.5px;
      display:flex; align-items:center; gap: var(--space-3);
    }
    .page-header h1:before { content:'üìã'; font-size: 1.5rem; }

    .actions { display:flex; gap: var(--space-3); flex-wrap: wrap; }

    .btn {
      background: var(--bg-surface);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      padding: var(--space-2) var(--space-4);
      font-family: var(--font-primary);
      font-size: 0.875rem;
      font-weight: 800;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--transition-base);
      display:inline-flex; align-items:center; gap: var(--space-2);
    }
    .btn:hover { background: var(--gray-50); border-color: var(--gray-300); transform: translateY(-2px); box-shadow: var(--shadow-sm); }
    .btn-primary { background: var(--primary-500); border-color: transparent; color: var(--text-inverse); box-shadow: var(--shadow-primary); }
    .btn-primary:hover { background: var(--primary-600); box-shadow: var(--shadow-lg); }
    .btn-success { background: var(--success); border-color: transparent; color: var(--text-inverse); }
    .btn-danger { background: var(--danger); border-color: transparent; color: var(--text-inverse); }
    .btn-warning { background: var(--warning); border-color: transparent; color: var(--text-inverse); }

    .panel {
      background: var(--bg-surface);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      box-shadow: var(--shadow-md);
      margin-bottom: var(--space-6);
    }
    .panel-title {
      font-family: var(--font-primary);
      font-size: 1.125rem;
      font-weight: 900;
      margin-bottom: var(--space-5);
      display:flex; align-items:center; gap: var(--space-2);
    }

    .form-row { display:grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); }
    @media (max-width: 720px) { .form-row { grid-template-columns: 1fr; } }

    .field { display:flex; flex-direction:column; gap: var(--space-2); margin-bottom: var(--space-4); }
    label { font-size: 0.875rem; font-weight: 800; color: var(--text-secondary); }
    .hint { font-size: 0.75rem; color: var(--text-tertiary); font-weight: 600; }

    input, select, textarea {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      font-family: var(--font-secondary);
      font-size: 0.875rem;
      transition: all var(--transition-base);
      background: var(--bg-surface);
      color: var(--text-primary);
    }
    textarea { min-height: 96px; resize: vertical; }

    input:focus, select:focus, textarea:focus {
      outline:none;
      border-color: var(--primary-400);
      box-shadow: 0 0 0 3px rgba(14,165,233,.12);
    }

    .table { width:100%; border-collapse: separate; border-spacing: 0; overflow:hidden; border-radius: var(--radius-xl); box-shadow: var(--shadow-sm); }
    .table th, .table td { padding: var(--space-3) var(--space-4); border-bottom: 1px solid var(--border-light); text-align:left; font-size: .875rem; vertical-align: top; }
    .table th { background: var(--gray-50); font-size: .75rem; text-transform: uppercase; letter-spacing: .5px; color: var(--text-secondary); }

    .tag {
      display:inline-flex; align-items:center; gap:.35rem;
      border-radius: var(--radius-full);
      padding: .25rem .6rem;
      font-size: .75rem;
      font-weight: 900;
      letter-spacing: .4px;
      text-transform: uppercase;
      border: 1px solid var(--border-light);
      background: var(--gray-50);
      color: var(--text-secondary);
      white-space: nowrap;
    }
    .tag.draft { background: var(--warning-light); color: #92400e; border-color: rgba(245,158,11,.25); }
    .tag.done  { background: var(--success-light); color: #065f46; border-color: rgba(16,185,129,.25); }
    .tag.bill  { background: rgba(14,165,233,0.10); color: var(--primary-700); border-color: rgba(14,165,233,0.18); }

    .empty {
      text-align:center;
      padding: var(--space-10);
      color: var(--text-tertiary);
      border: 1px dashed var(--border-medium);
      border-radius: var(--radius-xl);
      background: var(--gray-50);
      font-weight: 700;
    }

    .section-help {
      background: var(--primary-50);
      border: 1px solid rgba(14,165,233,0.15);
      border-radius: var(--radius-xl);
      padding: var(--space-4);
      color: var(--text-secondary);
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: var(--space-6);
    }

    .money { font-family: var(--font-primary); font-weight: 900; }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(17, 24, 39, 0.75);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn .25s ease-out;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOut { from { opacity:1; } to { opacity:0; } }

    .modal {
      background: var(--bg-surface);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      width: 920px;
      max-width: 96vw;
      max-height: 88vh;
      overflow: auto;
      box-shadow: var(--shadow-2xl);
      border: 1px solid var(--border-light);
      animation: slideUp .25s ease-out;
    }

    @keyframes slideUp { from { transform: translateY(12px); opacity:0; } to { transform: translateY(0); opacity:1; } }

    .modal-header { display:flex; justify-content: space-between; align-items:center; gap: var(--space-4); margin-bottom: var(--space-4); }
    .modal-header h3 { font-family: var(--font-primary); font-size: 1.125rem; font-weight: 900; }
    .modal-close {
      width: 36px; height:36px; border-radius: var(--radius-full);
      border: 1px solid var(--border-light);
      background: var(--bg-surface);
      cursor: pointer;
      font-size: 1.25rem;
      color: var(--text-secondary);
      transition: all var(--transition-base);
    }
    .modal-close:hover { background: var(--danger-light); border-color: var(--danger); color: var(--danger); }

    .modal-actions { display:flex; justify-content:flex-end; gap: var(--space-3); margin-top: var(--space-6); flex-wrap: wrap; }

    .tabs {
      display:flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      border-bottom: 1px solid var(--border-light);
      padding-bottom: var(--space-3);
      margin-bottom: var(--space-5);
    }
    .tab {
      border: 1px solid var(--border-light);
      background: var(--bg-surface);
      padding: .5rem .75rem;
      border-radius: var(--radius-full);
      font-family: var(--font-primary);
      font-weight: 900;
      font-size: .75rem;
      letter-spacing: .4px;
      text-transform: uppercase;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--transition-base);
      user-select: none;
    }
    .tab:hover { background: var(--gray-50); transform: translateY(-1px); }
    .tab.active { background: var(--primary-500); color: var(--text-inverse); border-color: transparent; box-shadow: var(--shadow-primary); }

    .tab-pane { display:none; }
    .tab-pane.active { display:block; }

    .split-row { display:grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); }
    @media (max-width: 900px) { .split-row { grid-template-columns: 1fr; } }

    .inline-actions { display:flex; gap: var(--space-2); flex-wrap: wrap; align-items: end; }

    .btn-icon {
      width: 36px;
      height: 36px;
      padding: 0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: var(--radius-md);
    }

    .pill {
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      padding:.25rem .65rem;
      border-radius: var(--radius-full);
      font-weight: 900;
      font-size: .75rem;
      background: var(--gray-50);
      border: 1px solid var(--border-light);
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .kpi-box {
      border: 1px solid var(--border-light);
      background: var(--gray-50);
      border-radius: var(--radius-xl);
      padding: var(--space-4);
    }
    .kpi-label { font-size: .75rem; font-weight: 900; text-transform: uppercase; letter-spacing: .5px; color: var(--text-tertiary); }
    .kpi-value { font-family: var(--font-primary); font-size: 1.35rem; font-weight: 900; margin-top: .25rem; }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      padding: .75rem 1rem;
      border-radius: var(--radius-xl);
      color: white;
      font-weight: 900;
      box-shadow: var(--shadow-lg);
      max-width: 520px;
      animation: slideUp .2s ease-out;
    }
    @keyframes slideUp { from { transform: translateY(10px); opacity:0; } to { transform: translateY(0); opacity:1; } }

    .fulfillment {
      border: 1px solid var(--border-light);
      background: var(--gray-50);
      border-radius: var(--radius-xl);
      padding: var(--space-4);
      margin-top: var(--space-4);
    }
    .fulfillment-title {
      font-size: .75rem;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: .5px;
      font-weight: 900;
      margin-bottom: var(--space-3);
    }
    .radio-row {
      display:flex;
      align-items:flex-start;
      gap: var(--space-2);
      padding: var(--space-3);
      border: 1px solid var(--border-light);
      background: var(--bg-surface);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all var(--transition-base);
      user-select: none;
      margin-bottom: var(--space-2);
    }
    .radio-row:hover { border-color: var(--primary-300); background: var(--primary-50); }
    .radio-row input { cursor: pointer; margin-top: 2px; }
    .radio-row strong { font-family: var(--font-primary); font-size: .875rem; }
    .radio-row small { display:block; font-size: .75rem; color: var(--text-tertiary); margin-top: 2px; }

    @media (max-width: 768px){
      .layout{ grid-template-columns: 1fr; }
      .sidebar-wrapper{
        position: fixed;
        bottom: 0;
        top: auto;
        height: auto;
        width: 100%;
        border-right: none;
        border-top: 1px solid var(--border-light);
        z-index: 1000;
      }
      .sidebar{ padding: var(--space-4) 0; flex-direction: row; align-items:center; }
      .menu{ display:flex; overflow-x:auto; flex: 0 0 auto; }
      .menu li{ margin:0; }
      .menu a{ flex-direction: column; padding: var(--space-2); }
      .menu-text{ font-size: 0.625rem; }
      .content{ padding: var(--space-4); }
      .topbar{ padding: var(--space-4); }
      .page-header{ flex-direction: column; align-items:flex-start; }
    }
  </style>
</head>

<body>
  <div class="layout" id="mainLayout">
    <div class="sidebar-wrapper">
      <aside class="sidebar">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon" onclick="toggleSidebar()">OS</div>
          <div class="sidebar-logo-text">
            <h1>OS Flow</h1>
            <small>Dashboard Inteligente</small>
          </div>
        </div>

        <ul class="menu">
          <li><a href="index.html"><span class="menu-icon">üìä</span><span class="menu-text">Dashboard</span><span class="menu-tooltip">Dashboard</span></a></li>
          <li><a href="cadastrar-clientes.html"><span class="menu-icon">üë•</span><span class="menu-text">Clientes</span><span class="menu-tooltip">Clientes</span></a></li>
          <li><a href="produtos.html"><span class="menu-icon">üì¶</span><span class="menu-text">Produtos</span><span class="menu-tooltip">Produtos</span></a></li>
          <li><a href="servicos.html"><span class="menu-icon">üîß</span><span class="menu-text">Servi√ßos</span><span class="menu-tooltip">Servi√ßos</span></a></li>
          <li><a href="vendas.html"><span class="menu-icon">üí∞</span><span class="menu-text">Vendas</span><span class="menu-tooltip">Vendas</span></a></li>
          <li><a href="ordem-servico.html" class="active"><span class="menu-icon">üìã</span><span class="menu-text">Ordens</span><span class="menu-tooltip">Ordens</span></a></li>
          <li><a href="garantias.html"><span class="menu-icon">üõ°Ô∏è</span><span class="menu-text">Garantias</span><span class="menu-tooltip">Garantias</span></a></li>
          <li><a href="arquivos.html"><span class="menu-icon">üìÅ</span><span class="menu-text">Arquivos</span><span class="menu-tooltip">Arquivos</span></a></li>
          <li><a href="financeiro.html"><span class="menu-icon">üí≥</span><span class="menu-text">Financeiro</span><span class="menu-tooltip">Financeiro</span></a></li>
          <li><a href="cobranca.html"><span class="menu-icon">üìÑ</span><span class="menu-text">Cobran√ßa</span><span class="menu-tooltip">Cobran√ßa</span></a></li>
          <li><a href="configuracoes.html"><span class="menu-icon">‚öôÔ∏è</span><span class="menu-text">Configura√ß√µes</span><span class="menu-tooltip">Configura√ß√µes</span></a></li>
        </ul>

        <div class="sidebar-footer">v3.8.1 ‚Ä¢ ¬© <span id="ano-atual"></span> ‚Ä¢ OS Flow</div>
      </aside>
    </div>

    <div class="main-wrapper">
      <header class="topbar">
        <div class="topbar-title">
          Ordem de Servi√ßo
          <div class="breadcrumb"><span>Status: Recebido ‚Üí Diagn√≥stico ‚Üí Em reparo ‚Üí Aguardando buscar ‚Üí Pronto</span></div>
        </div>
        <div class="user-info">
          <span>Bem-vindo, <strong id="topUserName">Usu√°rio</strong></span>
          <div class="user-avatar" id="topUserAvatar">U</div>
        </div>
      </header>

      <main class="content">
        <div class="page-header">
          <h1>Ordens de Servi√ßo</h1>
          <div class="actions">
            <button class="btn" type="button" onclick="resetCriacao()">üÜï Nova OS</button>
            <a class="btn" href="configuracoes.html" target="_blank" rel="noopener">‚öôÔ∏è Tipos/Checklist</a>
          </div>
        </div>

        <section class="panel">
          <div class="panel-title">üë• Criar OS (dados do cliente)</div>

          <div class="section-help">
            Fluxo: crie a OS com o <strong>cliente</strong>. Depois, na lista, clique em <strong>Editar</strong> para preencher
            equipamento (tipo cadastrado em Configura√ß√µes), din√¢micos, checklist, produtos/servi√ßos e faturar.
          </div>

          <form id="osCreateForm" onsubmit="criarOSBasica(event)">
            <div class="form-row">
              <div class="field">
                <label for="clienteSelect">Cliente cadastrado</label>
                <select id="clienteSelect" onchange="onClienteSelecionado()">
                  <option value="">Selecionar...</option>
                </select>
                <div class="hint">Puxa do cadastro.</div>
              </div>

              <div class="field">
                <label for="clienteNome">Nome do cliente (snapshot)</label>
                <input id="clienteNome" placeholder="Digite o nome do cliente" required />
              </div>
            </div>

            <div class="form-row">
              <div class="field">
                <label for="clienteTelefone">Telefone</label>
                <input id="clienteTelefone" placeholder="(11) 99999-9999" />
              </div>

              <div class="field">
                <label for="clienteEmail">E-mail</label>
                <input id="clienteEmail" placeholder="cliente@email.com" />
              </div>
            </div>

            <div class="actions">
              <button class="btn btn-primary" type="submit">üíæ Salvar e criar OS</button>
            </div>
          </form>
        </section>

        <section class="panel">
          <div class="panel-title">üìö OS criadas</div>

          <div class="form-row">
            <div class="field" style="margin-bottom:0;">
              <label for="buscarOS">Buscar</label>
              <input id="buscarOS" placeholder="Buscar por n√∫mero ou cliente..." oninput="renderListaOS()" />
            </div>
            <div class="field" style="margin-bottom:0;">
              <label for="filtroStatus">Status</label>
              <select id="filtroStatus" onchange="renderListaOS()">
                <option value="">Todos</option>
                <option value="recebido">Recebido</option>
                <option value="diagnostico">Diagn√≥stico</option>
                <option value="reparo">Em reparo</option>
                <option value="aguardando_buscar">Aguardando cliente buscar</option>
                <option value="pronto">Pronto</option>
                <option value="finalizada">Finalizada</option>
              </select>
            </div>
          </div>

          <div style="overflow:auto; margin-top: var(--space-4);">
            <table class="table" aria-label="Lista de OS" id="osTable">
              <thead>
                <tr>
                  <th>N¬∫ OS</th>
                  <th>Cliente</th>
                  <th>Status</th>
                  <th>Faturamento</th>
                  <th style="text-align:right;">Total</th>
                  <th>Criada em</th>
                  <th style="width: 340px;">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="osList"></tbody>
            </table>
          </div>

          <div id="emptyOS" class="empty" style="display:none; margin-top: var(--space-4);">
            Nenhuma OS criada ainda. Use o formul√°rio acima para criar a primeira.
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- MODAL EDITAR OS -->
  <div class="modal-backdrop" id="modalEditarOS">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalEditarTitulo">Editar OS</h3>
        <button class="modal-close" type="button" onclick="fecharModalEditar()">√ó</button>
      </div>

      <div class="tabs" role="tablist" aria-label="Abas de edi√ß√£o da OS">
        <button class="tab active" type="button" onclick="selectTab('tab-geral')" id="btn-tab-geral">Geral</button>
        <button class="tab" type="button" onclick="selectTab('tab-equipamento')" id="btn-tab-equipamento">Equipamento</button>
        <button class="tab" type="button" onclick="selectTab('tab-dinamicos')" id="btn-tab-dinamicos">Din√¢micos</button>
        <button class="tab" type="button" onclick="selectTab('tab-checklist')" id="btn-tab-checklist">Checklist</button>
        <button class="tab" type="button" onclick="selectTab('tab-anexos')" id="btn-tab-anexos">Anexos</button>
        <button class="tab" type="button" onclick="selectTab('tab-produtos')" id="btn-tab-produtos">Produtos</button>
        <button class="tab" type="button" onclick="selectTab('tab-servicos')" id="btn-tab-servicos">Servi√ßos</button>
        <button class="tab" type="button" onclick="selectTab('tab-faturamento')" id="btn-tab-faturamento">Faturar</button>
        <button class="tab" type="button" onclick="selectTab('tab-termo')" id="btn-tab-termo">Garantia</button>
      </div>

      <form id="osEditForm" onsubmit="salvarDetalhesOS(event)">
        <!-- Geral -->
        <div class="tab-pane active" id="tab-geral" role="tabpanel" aria-labelledby="btn-tab-geral">
          <div class="panel-title" style="margin-top:0;">üìå Controle</div>

          <div class="form-row">
            <div class="field">
              <label for="editNumeroOS">N√∫mero OS</label>
              <input id="editNumeroOS" readonly />
              <div class="hint">Gerado automaticamente na cria√ß√£o.</div>
            </div>

            <div class="field">
              <label for="editStatus">Status</label>
              <select id="editStatus">
                <option value="recebido">Recebido</option>
                <option value="diagnostico">Diagn√≥stico</option>
                <option value="reparo">Em reparo</option>
                <option value="aguardando_buscar">Aguardando cliente buscar</option>
                <option value="pronto">Pronto</option>
                <option value="finalizada">Finalizada</option>
              </select>
              <div class="hint">Finalizada = cancelada / cliente desistiu / sem servi√ßo.</div>
            </div>
          </div>

          <div class="panel-title">üß† Defeito / Diagn√≥stico</div>

          <div class="field">
            <label for="editDefeitoRelatado">Defeito relatado</label>
            <textarea id="editDefeitoRelatado" placeholder="O que o cliente informou"></textarea>
          </div>

          <div class="field">
            <label for="editDiagnostico">Diagn√≥stico t√©cnico</label>
            <textarea id="editDiagnostico" placeholder="An√°lise do t√©cnico"></textarea>
          </div>

          <div class="panel-title">üìù Observa√ß√µes gerais</div>
          <div class="field">
            <label for="editObsGeral">Observa√ß√µes</label>
            <textarea id="editObsGeral" placeholder="Observa√ß√µes internas"></textarea>
          </div>
        </div>

        <!-- Equipamento -->
        <div class="tab-pane" id="tab-equipamento" role="tabpanel" aria-labelledby="btn-tab-equipamento">
          <div class="panel-title">üì± Equipamento</div>

          <div class="section-help">
            Os tipos e campos din√¢micos v√™m de <strong>Configura√ß√µes ‚Üí Tipos de Equipamento</strong>.
          </div>

          <div class="form-row">
            <div class="field">
              <label for="editTipoEquipamento">Tipo</label>
              <select id="editTipoEquipamento" onchange="onModalTipoEquipamentoChange()">
                <option value="">Carregando...</option>
              </select>
              <div class="hint">A lista √© controlada pelo Configura√ß√µes (din√¢micos).</div>
            </div>

            <div class="field">
              <label for="editMarcaModelo">Marca / Modelo</label>
              <input id="editMarcaModelo" placeholder="Ex: iPhone 14 / Dell XPS / Samsung UN50..." />
            </div>
          </div>

          <div class="form-row">
            <div class="field">
              <label for="editSerial">Serial / IMEI</label>
              <input id="editSerial" placeholder="Opcional" />
            </div>

            <div class="field">
              <label for="editSenha">Senha (se houver)</label>
              <input id="editSenha" placeholder="Opcional" />
            </div>
          </div>

          <div class="field">
            <label for="editAcessorios">Acess√≥rios entregues</label>
            <input id="editAcessorios" placeholder="carregador, cabo, controle..." />
          </div>

          <div class="field">
            <label for="editEstadoFisico">Estado f√≠sico</label>
            <textarea id="editEstadoFisico" placeholder="Riscos, trincas, manchas..."></textarea>
          </div>
        </div>

        <!-- Din√¢micos -->
        <div class="tab-pane" id="tab-dinamicos">
          <div class="panel-title">üß© Campos Din√¢micos do Equipamento</div>
          <div class="section-help">
            Esses campos s√£o definidos em <strong>Configura√ß√µes</strong>. Eles aparecem conforme o tipo selecionado.
          </div>

          <div id="dinamicosSlot" class="empty">Selecione o tipo do equipamento.</div>
        </div>

        <!-- Checklist -->
        <div class="tab-pane" id="tab-checklist">
          <div class="panel-title">‚úÖ Checklist de Recebimento</div>
          <div class="section-help">Checklist definido em Configura√ß√µes por tipo.</div>
          <div id="checklistSlot" class="empty">Selecione o tipo do equipamento.</div>
        </div>

        <!-- Anexos -->
        <div class="tab-pane" id="tab-anexos">
          <div class="panel-title">üìé Anexos / Fotos / V√≠deos</div>
          <div class="section-help">
            Integra√ß√£o com <strong>arquivos.html</strong> (pasta por OS). Para anexar, use a p√°gina Arquivos e selecione a OS.
          </div>

          <div class="form-row">
            <div class="field">
              <label for="editAnexosGroupKey">Chave de grupo</label>
              <input id="editAnexosGroupKey" placeholder="osflow:files:os|<osId>" readonly />
            </div>
            <div class="field">
              <label for="editAnexosIds">IDs vinculados</label>
              <input id="editAnexosIds" placeholder="id1,id2,id3" readonly />
            </div>
          </div>

          <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
            <button class="btn" type="button" onclick="window.open('arquivos.html', '_blank')">üìÅ Abrir Arquivos</button>
          </div>
        </div>

        <!-- Produtos -->
        <div class="tab-pane" id="tab-produtos">
          <div class="panel-title">üì¶ Produtos (estoque) na OS</div>
          <div class="section-help">Gera valores. Baixa estoque apenas ao pagar (ou pagar agora no faturamento).</div>

          <div class="split-row">
            <div class="field" style="margin-bottom:0;">
              <label for="buscarProduto">Buscar produto</label>
              <input id="buscarProduto" placeholder="Nome, c√≥digo..." oninput="renderProdutosBusca()" />
            </div>
            <div class="field" style="margin-bottom:0;">
              <label>A√ß√µes</label>
              <div class="inline-actions">
                <button class="btn" type="button" onclick="renderProdutosBusca()">üîç Buscar</button>
                <button class="btn" type="button" onclick="limparBuscaProduto()">üßπ Limpar</button>
              </div>
            </div>
          </div>

          <div style="overflow:auto; margin-top: var(--space-4);">
            <table class="table">
              <thead>
                <tr>
                  <th>Produto</th>
                  <th>Estoque</th>
                  <th style="text-align:right;">Pre√ßo</th>
                  <th style="width:160px;">Qtd</th>
                  <th style="width:120px;">A√ß√£o</th>
                </tr>
              </thead>
              <tbody id="produtoBuscaTbody"></tbody>
            </table>
          </div>

          <div class="panel-title" style="margin-top: var(--space-8);">üõí Itens na OS</div>
          <div style="overflow:auto;">
            <table class="table">
              <thead>
                <tr>
                  <th>Item</th>
                  <th style="text-align:right;">Pre√ßo</th>
                  <th style="text-align:center;">Qtd</th>
                  <th style="text-align:right;">Subtotal</th>
                  <th style="width:120px;">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="osProdutosTbody"></tbody>
            </table>
          </div>
          <div id="osProdutosEmpty" class="empty" style="display:none; margin-top: var(--space-4);">
            Nenhum produto adicionado nesta OS.
          </div>
        </div>

        <!-- Servi√ßos -->
        <div class="tab-pane" id="tab-servicos">
          <div class="panel-title">üîß Servi√ßos (cadastrados) na OS</div>
          <div class="section-help">Servi√ßos dispon√≠veis v√™m do cadastro de servi√ßos.</div>

          <div class="split-row">
            <div class="field" style="margin-bottom:0;">
              <label for="buscarServico">Buscar servi√ßo</label>
              <input id="buscarServico" placeholder="Nome..." oninput="renderServicosBusca()" />
            </div>
            <div class="field" style="margin-bottom:0;">
              <label>A√ß√µes</label>
              <div class="inline-actions">
                <button class="btn" type="button" onclick="renderServicosBusca()">üîç Buscar</button>
                <button class="btn" type="button" onclick="limparBuscaServico()">üßπ Limpar</button>
              </div>
            </div>
          </div>

          <div style="overflow:auto; margin-top: var(--space-4);">
            <table class="table">
              <thead>
                <tr>
                  <th>Servi√ßo</th>
                  <th style="text-align:right;">Valor</th>
                  <th style="width:120px;">A√ß√£o</th>
                </tr>
              </thead>
              <tbody id="servicoBuscaTbody"></tbody>
            </table>
          </div>

          <div class="panel-title" style="margin-top: var(--space-8);">üìå Servi√ßos anexados</div>
          <div style="overflow:auto;">
            <table class="table">
              <thead>
                <tr>
                  <th>Servi√ßo</th>
                  <th style="text-align:right;">Valor</th>
                  <th style="width:120px;">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="osServicosTbody"></tbody>
            </table>
          </div>
          <div id="osServicosEmpty" class="empty" style="display:none; margin-top: var(--space-4);">
            Nenhum servi√ßo anexado nesta OS.
          </div>
        </div>

        <!-- Faturamento -->
        <div class="tab-pane" id="tab-faturamento">
          <div class="panel-title">üí≥ Faturamento</div>
          <div class="section-help">Pagar agora baixa estoque. Gerar cobran√ßa n√£o baixa estoque (baixa somente quando marcar como paga em Cobran√ßa).</div>

          <div class="split-row">
            <div class="kpi-box">
              <div class="kpi-label">Subtotal produtos</div>
              <div class="kpi-value money" id="kpiSubProdutos">R$ 0,00</div>
            </div>
            <div class="kpi-box">
              <div class="kpi-label">Subtotal servi√ßos</div>
              <div class="kpi-value money" id="kpiSubServicos">R$ 0,00</div>
            </div>
            <div class="kpi-box">
              <div class="kpi-label">Desconto</div>
              <div class="kpi-value money" id="kpiDesconto">R$ 0,00</div>
            </div>
            <div class="kpi-box">
              <div class="kpi-label">Total</div>
              <div class="kpi-value money" id="kpiTotal">R$ 0,00</div>
            </div>
          </div>

          <div class="panel-title" style="margin-top: var(--space-8);">Ajustes</div>

          <div class="form-row">
            <div class="field">
              <label for="editDesconto">Desconto (R$)</label>
              <input id="editDesconto" type="number" min="0" step="0.01" value="0" oninput="updateFinanceKPIs()" />
            </div>
            <div class="field">
              <label for="editFormaPagamento">Forma de pagamento (prefer√™ncia)</label>
              <select id="editFormaPagamento">
                <option value="dinheiro">Dinheiro</option>
                <option value="pix">PIX</option>
                <option value="cartao">Cart√£o</option>
                <option value="boleto">Boleto</option>
                <option value="transferencia">Transfer√™ncia</option>
                <option value="outro">Outro</option>
              </select>
            </div>
          </div>

          <div class="panel-title">Status do faturamento</div>
          <div style="display:flex; gap: var(--space-2); flex-wrap:wrap; align-items:center;">
            <span class="pill" id="pillFaturamento">N√£o faturada</span>
            <span class="hint" id="hintFaturamento"></span>
          </div>

          <div class="modal-actions">
            <button class="btn btn-warning" type="button" onclick="abrirModalFaturamento()">üßæ Faturar OS</button>
          </div>
        </div>

        <!-- Termo -->
        <div class="tab-pane" id="tab-termo">
          <div class="panel-title">üßæ Garantia / Termo</div>
          <div class="section-help">Esta parte pode ser integrada depois com garantias.html.</div>

          <div class="form-row">
            <div class="field">
              <label for="editTermo">Selecionar garantia</label>
              <select id="editTermo" onchange="renderPreviewTermo()">
                <option value="30">Padr√£o 30 dias</option>
                <option value="90">Padr√£o 90 dias</option>
                <option value="0">Sem garantia</option>
              </select>
            </div>

            <div class="field">
              <label for="editTermoObs">Observa√ß√µes do termo</label>
              <input id="editTermoObs" placeholder="Opcional" oninput="renderPreviewTermo()" />
            </div>
          </div>

          <div id="previewTermo" class="empty" style="text-align:left;">
            Preview do termo.
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn" type="button" onclick="fecharModalEditar()">Cancelar</button>
          <button class="btn btn-success" type="submit">üíæ Salvar detalhes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL: Escolha de faturamento -->
  <div class="modal-backdrop" id="modalFaturamento">
    <div class="modal" style="width: 720px;">
      <div class="modal-header">
        <h3>üßæ Faturar OS</h3>
        <button class="modal-close" type="button" onclick="fecharModalFaturamento()">√ó</button>
      </div>

      <div class="section-help" id="faturamentoResumo"></div>

      <div class="fulfillment">
        <div class="fulfillment-title">Como finalizar</div>

        <label class="radio-row" for="osOptPayNow">
          <input type="radio" name="osFulfillment" id="osOptPayNow" value="pay_now" checked />
          <div>
            <strong>Pagar agora</strong>
            <small>Marca a OS como <b>faturada</b> e d√° baixa no estoque imediatamente.</small>
          </div>
        </label>

        <label class="radio-row" for="osOptCharge">
          <input type="radio" name="osFulfillment" id="osOptCharge" value="charge" />
          <div>
            <strong>Gerar cobran√ßa</strong>
            <small>Cria cobran√ßa em <b>cobranca.html</b> e deixa a OS como <b>aguardando pagamento</b>. Sem baixa no estoque at√© pagar.</small>
          </div>
        </label>
      </div>

      <div class="modal-actions">
        <button class="btn" type="button" onclick="fecharModalFaturamento()">Cancelar</button>
        <button class="btn btn-primary" type="button" onclick="confirmarFaturamento()">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    const LS = Object.freeze({
      clientes: 'osflow:clientes',
      os: 'osflow:os',
      config: 'osflow:config',
      produtos: 'osflow:produtos',
      servicos: 'osflow:servicos',
      cobrancas: 'osflow:cobrancas',
      sidebarCollapsed: 'osflow:ui:sidebarCollapsed',

      legacyClientes: 'clientesOSFlow',
      legacyOs: 'osflow_os',
      legacyConfig: 'osflow_config',
      legacySidebarCollapsed: 'sidebarCollapsed',
      legacyProdutos: 'produtosOSFlow',
      legacyServicos: 'servicosOSFlow'
    });

    function lsReadJSON(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        return JSON.parse(raw);
      } catch {
        return fallback;
      }
    }
    function lsWriteJSON(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }

    function migrateLocalStorageKeys() {
      if (!localStorage.getItem(LS.clientes) && localStorage.getItem(LS.legacyClientes)) localStorage.setItem(LS.clientes, localStorage.getItem(LS.legacyClientes));
      if (!localStorage.getItem(LS.os) && localStorage.getItem(LS.legacyOs)) localStorage.setItem(LS.os, localStorage.getItem(LS.legacyOs));
      if (!localStorage.getItem(LS.config) && localStorage.getItem(LS.legacyConfig)) localStorage.setItem(LS.config, localStorage.getItem(LS.legacyConfig));
      if (!localStorage.getItem(LS.sidebarCollapsed) && localStorage.getItem(LS.legacySidebarCollapsed)) localStorage.setItem(LS.sidebarCollapsed, localStorage.getItem(LS.legacySidebarCollapsed));
      if (!localStorage.getItem(LS.produtos) && localStorage.getItem(LS.legacyProdutos)) localStorage.setItem(LS.produtos, localStorage.getItem(LS.legacyProdutos));
      if (!localStorage.getItem(LS.servicos) && localStorage.getItem(LS.legacyServicos)) localStorage.setItem(LS.servicos, localStorage.getItem(LS.legacyServicos));
    }
    migrateLocalStorageKeys();

    const OS_KEY = LS.os;
    const PRODUTOS_KEY = LS.produtos;
    const SERVICOS_KEY = LS.servicos;

    let osEditandoId = null;

    function getOSList() { return lsReadJSON(OS_KEY, []); }
    function setOSList(list) { lsWriteJSON(OS_KEY, list); }
    function getProdutos() { return lsReadJSON(PRODUTOS_KEY, []); }
    function setProdutos(list) { lsWriteJSON(PRODUTOS_KEY, list); }
    function getServicos() { return lsReadJSON(SERVICOS_KEY, []); }
    function getClientes() { return lsReadJSON(LS.clientes, []); }

    function getCobrancas() {
      const list = lsReadJSON(LS.cobrancas, []);
      return Array.isArray(list) ? list : [];
    }
    function setCobrancas(list) { lsWriteJSON(LS.cobrancas, Array.isArray(list) ? list : []); }

    function getConfig() {
      const cfg = lsReadJSON(LS.config, null);
      if (!cfg) return { templates: { equipamentoTipos: [], equipamentoCamposByTipo: {}, checklistByTipo: {} }, usuario: { nome: '' } };
      return cfg;
    }
    function getTemplatesFromConfig() {
      const cfg = getConfig() || {};
      const t = cfg.templates || {};
      return {
        equipamentoTipos: Array.isArray(t.equipamentoTipos) ? t.equipamentoTipos : [],
        equipamentoCamposByTipo: t.equipamentoCamposByTipo || {},
        checklistByTipo: t.checklistByTipo || {}
      };
    }

    function renderTopUser() {
      const cfg = getConfig();
      const name = (cfg?.usuario?.nome || 'Usu√°rio').trim() || 'Usu√°rio';
      const initial = (name[0] || 'U').toUpperCase();
      const elName = document.getElementById('topUserName');
      const elAv = document.getElementById('topUserAvatar');
      if (elName) elName.textContent = name;
      if (elAv) elAv.textContent = initial;
    }

    function toggleSidebar() {
      const layout = document.getElementById('mainLayout');
      layout.classList.toggle('collapsed');
      localStorage.setItem(LS.sidebarCollapsed, layout.classList.contains('collapsed'));
    }

    function toast(message, type = 'info') {
      const colors = { info:'var(--primary-500)', success:'var(--success)', warning:'var(--warning)', danger:'var(--danger)' };
      const el = document.createElement('div');
      el.className = 'toast';
      el.style.background = colors[type] || colors.info;
      el.textContent = message;
      document.body.appendChild(el);
      setTimeout(() => {
        el.style.opacity = '0';
        el.style.transition = 'opacity .25s ease';
        setTimeout(() => el.remove(), 250);
      }, 2500);
    }

    function formatDateTime(iso) { try { return new Date(iso).toLocaleString('pt-BR'); } catch { return iso || '-'; } }
    function gerarNumeroOS() { return 'OS-' + String(Date.now()).slice(-6); }
    function formatBRL(n) { return Number(n || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }

    function statusTag(status) {
      const map = {
        recebido: ['Recebido', 'draft'],
        diagnostico: ['Diagn√≥stico', 'bill'],
        reparo: ['Em reparo', 'bill'],
        aguardando_buscar: ['Aguardando buscar', 'bill'],
        pronto: ['Pronto', 'done'],
        finalizada: ['Finalizada', 'draft']
      };
      const item = map[status] || map.recebido;
      return `<span class="tag ${item[1]}">${item[0]}</span>`;
    }

    function faturamentoTag(fin) {
      // fin.statusFaturamento: 'nao_faturada' | 'pending' | 'faturada'
      const st = fin?.statusFaturamento || 'nao_faturada';
      if (st === 'faturada') return `<span class="tag bill">Faturada</span>`;
      if (st === 'pending') return `<span class="tag draft">Aguardando</span>`;
      return `<span class="tag draft">N√£o faturada</span>`;
    }

    function escapeHTML(s) {
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }
    function escapeHTMLAttr(s) { return String(s ?? '').replaceAll('"','').replaceAll("'",'').replaceAll(' ', '_'); }
    function escapeJS(s) { return String(s ?? '').replaceAll('\\','\\\\').replaceAll("'","\\'"); }

    // Clientes
    function preencherSelectClientes() {
      const select = document.getElementById('clienteSelect');
      if (!select) return;
      const clientes = getClientes().sort((a,b) => (a.nome||'').localeCompare(b.nome||''));
      select.innerHTML = `<option value="">Selecionar...</option>` + clientes.map(c => `
        <option value="${escapeHTMLAttr(String(c.id))}">${escapeHTML(c.nome)}</option>
      `).join('');
    }

    function onClienteSelecionado() {
      const id = document.getElementById('clienteSelect').value;
      if (!id) return;
      const c = getClientes().find(x => String(x.id) === String(id));
      if (!c) return;
      document.getElementById('clienteNome').value = c.nome || '';
      document.getElementById('clienteTelefone').value = c.telefone || '';
      document.getElementById('clienteEmail').value = c.email || '';
    }

    function resetCriacao() {
      document.getElementById('osCreateForm').reset();
      document.getElementById('clienteSelect').value = '';
    }

    function syncOSIntoCalendarIndexStorage(os) {
      const KEY = 'osflow:calendar:orders';
      const list = lsReadJSON(KEY, []) || [];
      const item = {
        id: os.id,
        customerName: os?.cliente?.nome || 'Cliente',
        deviceType: os?.detalhes?.equipamento?.marcaModelo || (os?.detalhes?.equipamento?.tipo ? `Tipo: ${os.detalhes.equipamento.tipo}` : 'Equipamento'),
        status: statusTag(os.status).replaceAll(/<[^>]*>/g, ''),
        createdAt: os.createdAt
      };
      const idx = list.findIndex(x => String(x.id) === String(item.id));
      if (idx >= 0) list[idx] = item;
      else list.unshift(item);
      lsWriteJSON(KEY, list);
    }

    function criarOSBasica(event) {
      event.preventDefault();

      const clienteNome = (document.getElementById('clienteNome').value || '').trim();
      if (!clienteNome) return;

      const now = new Date().toISOString();

      const os = {
        id: String(Date.now()),
        numero: gerarNumeroOS(),
        status: 'recebido',
        createdAt: now,
        updatedAt: now,

        cliente: {
          clienteId: document.getElementById('clienteSelect').value || '',
          nome: clienteNome,
          telefone: (document.getElementById('clienteTelefone').value || '').trim(),
          email: (document.getElementById('clienteEmail').value || '').trim()
        },

        detalhes: {
          equipamento: { tipo:'', marcaModelo:'', serial:'', senha:'', acessorios:'', estadoFisico:'' },
          dinamicos: {},
          checklist: { templateId: null, answers: {} },
          anexos: { groupKey: '', ids: [] },

          defeitoRelatado: '',
          diagnostico: '',

          termo: { tipo: '30', observacao: '' },
          observacoesGerais: '',

          itensVenda: [],
          servicosAplicados: [],

          financeiro: {
            desconto: 0,
            total: 0,
            subtotalProdutos: 0,
            subtotalServicos: 0,
            statusFaturamento: 'nao_faturada', // <- agora inclui pending
            faturadoEm: '',
            formaPagamento: '',
            cobrancaId: null
          }
        }
      };

      os.detalhes.anexos.groupKey = `osflow:files:os|${os.id}`;

      const list = getOSList();
      list.unshift(os);
      setOSList(list);

      syncOSIntoCalendarIndexStorage(os);

      resetCriacao();
      renderListaOS();
      toast('OS criada (Recebido). Clique em Editar para completar.', 'success');
    }

    function calcularTotaisOS(os) {
      const itens = os.detalhes?.itensVenda || [];
      const servs = os.detalhes?.servicosAplicados || [];
      const desconto = Number(os.detalhes?.financeiro?.desconto || 0);

      const subtotalProdutos = itens.reduce((acc, it) => acc + (Number(it.preco || 0) * Number(it.qtd || 0)), 0);
      const subtotalServicos = servs.reduce((acc, s) => acc + (Number(s.valor || 0)), 0);
      const total = Math.max(0, subtotalProdutos + subtotalServicos - desconto);

      return { subtotalProdutos, subtotalServicos, desconto, total };
    }

    function renderListaOS() {
      const tbody = document.getElementById('osList');
      const empty = document.getElementById('emptyOS');
      if (!tbody || !empty) return;

      const term = (document.getElementById('buscarOS')?.value || '').toLowerCase().trim();
      const filtroStatus = (document.getElementById('filtroStatus')?.value || '').trim();

      let list = getOSList();
      if (filtroStatus) list = list.filter(o => o.status === filtroStatus);
      if (term) {
        list = list.filter(o => {
          const hay = `${o.numero} ${o.cliente?.nome}`.toLowerCase();
          return hay.includes(term);
        });
      }

      if (!list.length) {
        tbody.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      tbody.innerHTML = list.map(o => {
        const totals = calcularTotaisOS(o);
        const fin = o.detalhes?.financeiro || {};
        return `
          <tr>
            <td><strong>${escapeHTML(o.numero)}</strong></td>
            <td>
              <div style="font-weight:900;">${escapeHTML(o.cliente?.nome || '-')}</div>
              <div class="hint">${escapeHTML(o.cliente?.telefone || '')}</div>
            </td>
            <td>${statusTag(o.status)}</td>
            <td>${faturamentoTag(fin)}</td>
            <td style="text-align:right;"><span class="money">${formatBRL(totals.total)}</span></td>
            <td>${formatDateTime(o.createdAt)}</td>
            <td>
              <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
                <button class="btn" type="button" onclick="abrirModalEditar('${escapeJS(o.id)}')">‚úèÔ∏è Editar</button>
                <button class="btn btn-warning" type="button" onclick="abrirModalFaturar('${escapeJS(o.id)}')">üßæ Faturar</button>
                <button class="btn btn-danger" type="button" onclick="excluirOS('${escapeJS(o.id)}')">üóëÔ∏è Excluir</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function excluirOS(id) {
      const os = getOSList().find(x => x.id === id);
      if (!os) return;
      if (!confirm(`Excluir ${os.numero}?`)) return;

      setOSList(getOSList().filter(x => x.id !== id));

      const KEY = 'osflow:calendar:orders';
      const list = lsReadJSON(KEY, []) || [];
      lsWriteJSON(KEY, list.filter(x => String(x.id) !== String(id)));

      renderListaOS();
      toast('OS exclu√≠da.', 'warning');
    }

    // Modal / Tabs
    function selectTab(paneId) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));

      const pane = document.getElementById(paneId);
      if (!pane) return;
      pane.classList.add('active');

      const btnId = 'btn-' + paneId;
      const btn = document.getElementById(btnId);
      if (btn) btn.classList.add('active');

      if (paneId === 'tab-faturamento') updateFinanceKPIs();
      if (paneId === 'tab-produtos') { renderProdutosBusca(); renderOSProdutos(); }
      if (paneId === 'tab-servicos') { renderServicosBusca(); renderOSServicos(); }
      if (paneId === 'tab-anexos') { renderAnexosLinkInfo(); }
      if (paneId === 'tab-dinamicos') { renderDinamicosSlot(); applyDynamicValuesToUI(getOsById(osEditandoId)); }
      if (paneId === 'tab-checklist') { renderChecklistSlot(); }
    }

    function getOsById(id) { return getOSList().find(x => x.id === id) || null; }
    function setOsById(os) {
      const list = getOSList();
      const idx = list.findIndex(x => x.id === os.id);
      if (idx >= 0) list[idx] = os;
      setOSList(list);
      syncOSIntoCalendarIndexStorage(os);
    }

    function abrirModalEditar(id) {
      const os = getOsById(id);
      if (!os) return;
      osEditandoId = id;

      if (!os.detalhes?.anexos) os.detalhes.anexos = { groupKey: `osflow:files:os|${os.id}`, ids: [] };
      if (!os.detalhes.anexos.groupKey) os.detalhes.anexos.groupKey = `osflow:files:os|${os.id}`;

      if (!os.detalhes.financeiro) {
        os.detalhes.financeiro = {
          desconto: 0, total: 0, subtotalProdutos: 0, subtotalServicos: 0,
          statusFaturamento: 'nao_faturada', faturadoEm: '', formaPagamento: '', cobrancaId: null
        };
      }
      if (!('statusFaturamento' in os.detalhes.financeiro)) os.detalhes.financeiro.statusFaturamento = 'nao_faturada';
      if (!('cobrancaId' in os.detalhes.financeiro)) os.detalhes.financeiro.cobrancaId = null;

      document.getElementById('modalEditarTitulo').textContent = `Editar OS ‚Ä¢ ${os.numero}`;
      document.getElementById('editNumeroOS').value = os.numero;
      document.getElementById('editStatus').value = os.status || 'recebido';

      fillTiposEquipamentoSelect(os.detalhes?.equipamento?.tipo || '');
      document.getElementById('editMarcaModelo').value = os.detalhes?.equipamento?.marcaModelo || '';
      document.getElementById('editSerial').value = os.detalhes?.equipamento?.serial || '';
      document.getElementById('editSenha').value = os.detalhes?.equipamento?.senha || '';
      document.getElementById('editAcessorios').value = os.detalhes?.equipamento?.acessorios || '';
      document.getElementById('editEstadoFisico').value = os.detalhes?.equipamento?.estadoFisico || '';

      document.getElementById('editDefeitoRelatado').value = os.detalhes?.defeitoRelatado || '';
      document.getElementById('editDiagnostico').value = os.detalhes?.diagnostico || '';
      document.getElementById('editObsGeral').value = os.detalhes?.observacoesGerais || '';

      document.getElementById('editTermo').value = os.detalhes?.termo?.tipo || '30';
      document.getElementById('editTermoObs').value = os.detalhes?.termo?.observacao || '';
      renderPreviewTermo();

      document.getElementById('editAnexosGroupKey').value = os.detalhes?.anexos?.groupKey || `osflow:files:os|${os.id}`;
      document.getElementById('editAnexosIds').value = (os.detalhes?.anexos?.ids || []).join(',');

      document.getElementById('editDesconto').value = String(Number(os.detalhes?.financeiro?.desconto || 0));
      document.getElementById('editFormaPagamento').value = os.detalhes?.financeiro?.formaPagamento || 'dinheiro';

      onModalTipoEquipamentoChange(false);

      renderProdutosBusca();
      renderServicosBusca();
      renderOSProdutos();
      renderOSServicos();
      updateFinanceKPIs();

      selectTab('tab-geral');
      document.getElementById('modalEditarOS').style.display = 'flex';
    }

    function abrirModalFaturar(id) {
      abrirModalEditar(id);
      selectTab('tab-faturamento');
    }

    function fecharModalEditar() {
      document.getElementById('modalEditarOS').style.display = 'none';
      osEditandoId = null;
    }

    function salvarDetalhesOS(event) {
      event.preventDefault();
      if (!osEditandoId) return;

      const os = getOsById(osEditandoId);
      if (!os) return;

      os.status = document.getElementById('editStatus').value || os.status;
      os.updatedAt = new Date().toISOString();

      const tipo = document.getElementById('editTipoEquipamento').value || '';

      os.detalhes.equipamento = {
        tipo,
        marcaModelo: (document.getElementById('editMarcaModelo').value || '').trim(),
        serial: (document.getElementById('editSerial').value || '').trim(),
        senha: (document.getElementById('editSenha').value || '').trim(),
        acessorios: (document.getElementById('editAcessorios').value || '').trim(),
        estadoFisico: (document.getElementById('editEstadoFisico').value || '').trim()
      };

      os.detalhes.defeitoRelatado = (document.getElementById('editDefeitoRelatado').value || '').trim();
      os.detalhes.diagnostico = (document.getElementById('editDiagnostico').value || '').trim();
      os.detalhes.observacoesGerais = (document.getElementById('editObsGeral').value || '').trim();

      os.detalhes.termo = {
        tipo: document.getElementById('editTermo').value || '30',
        observacao: (document.getElementById('editTermoObs').value || '').trim()
      };

      if (!os.detalhes.anexos) os.detalhes.anexos = { groupKey: `osflow:files:os|${os.id}`, ids: [] };
      if (!os.detalhes.anexos.groupKey) os.detalhes.anexos.groupKey = `osflow:files:os|${os.id}`;

      saveDynamicFieldsFromUI(os);
      saveChecklistFromUI(os);

      os.detalhes.financeiro.desconto = Number(document.getElementById('editDesconto').value || 0);
      os.detalhes.financeiro.formaPagamento = document.getElementById('editFormaPagamento').value || '';

      const totals = calcularTotaisOS(os);
      os.detalhes.financeiro.subtotalProdutos = totals.subtotalProdutos;
      os.detalhes.financeiro.subtotalServicos = totals.subtotalServicos;
      os.detalhes.financeiro.total = totals.total;

      setOsById(os);
      renderListaOS();
      updateFinanceKPIs();
      renderAnexosLinkInfo();
      toast('Detalhes salvos.', 'success');
    }

    // Tipos / Config
    function fillTiposEquipamentoSelect(selectedId = '') {
      const select = document.getElementById('editTipoEquipamento');
      if (!select) return;

      const templates = getTemplatesFromConfig();
      const tipos = templates.equipamentoTipos || [];

      select.innerHTML = `<option value="">Selecionar...</option>` + tipos
        .slice()
        .sort((a,b) => (a.label||'').localeCompare(b.label||''))
        .map(t => `<option value="${escapeHTMLAttr(String(t.id))}">${escapeHTML(t.label || t.id)}</option>`)
        .join('');

      if (selectedId) select.value = selectedId;
    }

    function onModalTipoEquipamentoChange(resetValues = true) {
      if (!osEditandoId) return;
      const os = getOsById(osEditandoId);
      if (!os) return;

      const tipo = document.getElementById('editTipoEquipamento')?.value || '';

      os.detalhes.checklist.templateId = tipo || null;

      if (resetValues) {
        os.detalhes.dinamicos = {};
        os.detalhes.checklist.answers = {};
        setOsById(os);
      } else {
        os.detalhes.dinamicos = os.detalhes.dinamicos || {};
        os.detalhes.checklist = os.detalhes.checklist || { templateId: null, answers: {} };
        os.detalhes.checklist.answers = os.detalhes.checklist.answers || {};
      }

      renderDinamicosSlot();
      applyDynamicValuesToUI(os);
      renderChecklistSlot();
    }

    function renderDinamicosSlot() {
      const dinamicosSlot = document.getElementById('dinamicosSlot');
      if (!dinamicosSlot) return;

      if (!osEditandoId) return;
      const os = getOsById(osEditandoId);
      if (!os) return;

      const tipo = document.getElementById('editTipoEquipamento')?.value || '';
      if (!tipo) {
        dinamicosSlot.className = 'empty';
        dinamicosSlot.textContent = 'Selecione o tipo do equipamento.';
        return;
      }

      const templates = getTemplatesFromConfig();
      const fields = templates.equipamentoCamposByTipo?.[tipo] || [];
      os.detalhes.dinamicos = os.detalhes.dinamicos || {};

      if (!fields.length) {
        dinamicosSlot.className = 'empty';
        dinamicosSlot.innerHTML = `Nenhum campo din√¢mico configurado para este tipo. V√° em <strong>Configura√ß√µes</strong> e adicione campos.`;
        return;
      }

      dinamicosSlot.className = '';
      dinamicosSlot.innerHTML = `
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
          ${fields.map(f => renderDynamicFieldControl(f, os.detalhes.dinamicos[f.id])).join('')}
        </div>
      `;
    }

    function renderDynamicFieldControl(field, value) {
      const id = String(field.id || '');
      const label = field.label || id;
      const kind = field.kind || 'text';
      const options = Array.isArray(field.options) ? field.options : [];
      const inputId = `dyn_${escapeHTMLAttr(id)}`;

      if (kind === 'textarea') {
        return `
          <div class="field">
            <label for="${inputId}">${escapeHTML(label)}</label>
            <textarea id="${inputId}" data-dyn-id="${escapeHTMLAttr(id)}"></textarea>
          </div>
        `;
      }

      if (kind === 'select') {
        const opts = ['<option value="">Selecionar...</option>']
          .concat(options.map(o => `<option value="${escapeHTMLAttr(String(o))}">${escapeHTML(String(o))}</option>`))
          .join('');
        return `
          <div class="field">
            <label for="${inputId}">${escapeHTML(label)}</label>
            <select id="${inputId}" data-dyn-id="${escapeHTMLAttr(id)}">${opts}</select>
          </div>
        `;
      }

      const inputType = kind === 'number' ? 'number' : 'text';
      return `
        <div class="field">
          <label for="${inputId}">${escapeHTML(label)}</label>
          <input id="${inputId}" data-dyn-id="${escapeHTMLAttr(id)}" type="${inputType}" />
        </div>
      `;
    }

    function applyDynamicValuesToUI(os) {
      const wrap = document.getElementById('dinamicosSlot');
      if (!wrap || !os) return;
      const values = os?.detalhes?.dinamicos || {};
      wrap.querySelectorAll('[data-dyn-id]').forEach(el => {
        const id = el.getAttribute('data-dyn-id');
        const v = values[id];
        if (v === undefined || v === null) return;
        el.value = String(v);
      });
    }

    function saveDynamicFieldsFromUI(os) {
      const wrap = document.getElementById('dinamicosSlot');
      if (!wrap) return;

      const next = {};
      wrap.querySelectorAll('[data-dyn-id]').forEach(el => {
        const id = el.getAttribute('data-dyn-id');
        if (!id) return;
        next[id] = el.value;
      });

      os.detalhes.dinamicos = next;
    }

    function renderChecklistSlot() {
      const checklistSlot = document.getElementById('checklistSlot');
      if (!checklistSlot) return;

      if (!osEditandoId) return;
      const os = getOsById(osEditandoId);
      if (!os) return;

      const tipo = document.getElementById('editTipoEquipamento')?.value || '';
      if (!tipo) {
        checklistSlot.className = 'empty';
        checklistSlot.textContent = 'Selecione o tipo do equipamento.';
        return;
      }

      const templates = getTemplatesFromConfig();
      const items = templates.checklistByTipo?.[tipo] || [];
      os.detalhes.checklist = os.detalhes.checklist || { templateId: null, answers: {} };
      os.detalhes.checklist.answers = os.detalhes.checklist.answers || {};

      if (!items.length) {
        checklistSlot.className = 'empty';
        checklistSlot.innerHTML = `Nenhum checklist configurado para este tipo. V√° em <strong>Configura√ß√µes</strong> e adicione itens.`;
        return;
      }

      checklistSlot.className = '';
      checklistSlot.innerHTML = `
        <div style="display:grid; gap: .5rem;">
          ${items.map(it => {
            const cid = String(it.id || '');
            const checked = !!os.detalhes.checklist.answers[cid];
            return `
              <label style="display:flex; align-items:center; gap:.6rem; padding:.6rem .75rem; border:1px solid var(--border-light); border-radius: var(--radius-lg); background: var(--gray-50); font-weight:800;">
                <input type="checkbox" data-check-id="${escapeHTMLAttr(cid)}" ${checked ? 'checked' : ''} />
                ${escapeHTML(it.label || cid)}
              </label>
            `;
          }).join('')}
        </div>
      `;
    }

    function saveChecklistFromUI(os) {
      const wrap = document.getElementById('checklistSlot');
      if (!wrap) return;

      const answers = {};
      wrap.querySelectorAll('[data-check-id]').forEach(el => {
        const id = el.getAttribute('data-check-id');
        answers[id] = !!el.checked;
      });

      os.detalhes.checklist.answers = answers;
      os.detalhes.checklist.templateId = document.getElementById('editTipoEquipamento')?.value || null;
    }

    function renderAnexosLinkInfo() {
      if (!osEditandoId) return;
      const os = getOsById(osEditandoId);
      if (!os) return;

      if (!os.detalhes?.anexos) os.detalhes.anexos = { groupKey: `osflow:files:os|${os.id}`, ids: [] };
      if (!os.detalhes.anexos.groupKey) os.detalhes.anexos.groupKey = `osflow:files:os|${os.id}`;
      setOsById(os);

      document.getElementById('editAnexosGroupKey').value = os.detalhes.anexos.groupKey;
      document.getElementById('editAnexosIds').value = (os.detalhes.anexos.ids || []).join(',');
    }

    function renderPreviewTermo() {
      const value = document.getElementById('editTermo')?.value || '30';
      const obs = (document.getElementById('editTermoObs')?.value || '').trim();
      const el = document.getElementById('previewTermo');
      if (!el) return;

      const label = value === '0' ? 'Sem garantia' : `${value} dias`;
      el.innerHTML = `
        <div style="font-weight:900; margin-bottom:.5rem;">Termo: ${escapeHTML(label)}</div>
        <div style="color: var(--text-tertiary); font-weight:700;">Observa√ß√µes: ${obs ? escapeHTML(obs) : '<em>(nenhuma)</em>'}</div>
      `;
    }

    // Produtos / Servi√ßos (mesmo que voc√™ j√° tinha)
    function limparBuscaProduto() { document.getElementById('buscarProduto').value = ''; renderProdutosBusca(); }
    function normalizeProdutoEstoque(p) { return Number(p?.estoque_atual ?? p?.estoque ?? p?.quantidade ?? p?.qtd ?? 0); }
    function normalizeProdutoPreco(p) { return Number(p?.preco_venda ?? p?.precoVenda ?? p?.preco ?? p?.valor ?? 0); }

    function renderProdutosBusca() {
      const tbody = document.getElementById('produtoBuscaTbody');
      if (!tbody) return;

      const term = (document.getElementById('buscarProduto')?.value || '').toLowerCase().trim();
      const produtos = getProdutos();

      let list = produtos;
      if (term) list = produtos.filter(p => `${p.nome||''} ${p.codigo||''} ${p.sku||''}`.toLowerCase().includes(term));
      list = list.slice(0, 20);

      if (!list.length) {
        tbody.innerHTML = `<tr><td colspan="5"><div class="empty" style="padding:1.25rem;">Nenhum produto encontrado.</div></td></tr>`;
        return;
      }

      tbody.innerHTML = list.map(p => {
        const estoque = normalizeProdutoEstoque(p);
        const preco = normalizeProdutoPreco(p);
        const disabled = estoque <= 0 ? 'disabled' : '';
        return `
          <tr>
            <td>
              <div style="font-weight:900;">${escapeHTML(p.nome || 'Produto')}</div>
              <div class="hint">${escapeHTML(p.codigo || p.sku || '')}</div>
            </td>
            <td>${estoque}</td>
            <td style="text-align:right;"><span class="money">${formatBRL(preco)}</span></td>
            <td><input type="number" min="1" step="1" value="1" id="qtdProd_${escapeHTMLAttr(String(p.id))}" ${disabled} /></td>
            <td><button class="btn btn-primary" type="button" ${disabled} onclick="adicionarProdutoOS('${escapeJS(String(p.id))}')">+ Adicionar</button></td>
          </tr>
        `;
      }).join('');
    }

    function adicionarProdutoOS(produtoId) {
      if (!osEditandoId) return;
      const os = getOsById(osEditandoId);
      if (!os) return;

      const produtos = getProdutos();
      const p = produtos.find(x => String(x.id) === String(produtoId));
      if (!p) return toast('Produto n√£o encontrado.', 'danger');

      const estoque = normalizeProdutoEstoque(p);
      const preco = normalizeProdutoPreco(p);

      const qtdInput = document.getElementById(`qtdProd_${String(p.id)}`);
      const qtd = Math.max(1, Number(qtdInput?.value || 1));

      if (qtd > estoque) return toast(`Estoque insuficiente. Dispon√≠vel: ${estoque}`, 'warning');

      const existing = os.detalhes.itensVenda.find(it => String(it.produtoId) === String(produtoId));
      if (existing) {
        const novaQtd = existing.qtd + qtd;
        if (novaQtd > estoque) return toast(`Estoque insuficiente para somar. Dispon√≠vel: ${estoque}`, 'warning');
        existing.qtd = novaQtd;
      } else {
        os.detalhes.itensVenda.push({ produtoId: String(p.id), nome: p.nome || 'Produto', preco, qtd });
      }

      setOsById(os);
      renderOSProdutos();
      updateFinanceKPIs();
      renderListaOS();
      toast('Produto adicionado.', 'success');
    }

    function renderOSProdutos() {
      const tbody = document.getElementById('osProdutosTbody');
      const empty = document.getElementById('osProdutosEmpty');
      if (!tbody || !empty) return;

      const os = osEditandoId ? getOsById(osEditandoId) : null;
      const itens = os?.detalhes?.itensVenda || [];

      if (!itens.length) {
        tbody.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      tbody.innerHTML = itens.map((it, idx) => {
        const subtotal = Number(it.preco || 0) * Number(it.qtd || 0);
        return `
          <tr>
            <td><div style="font-weight:900;">${escapeHTML(it.nome)}</div></td>
            <td style="text-align:right;"><span class="money">${formatBRL(it.preco)}</span></td>
            <td style="text-align:center;">
              <div style="display:flex; gap:.35rem; justify-content:center; align-items:center;">
                <button class="btn btn-icon" type="button" onclick="alterarQtdProduto(${idx}, -1)">‚àí</button>
                <span class="pill">${it.qtd}</span>
                <button class="btn btn-icon" type="button" onclick="alterarQtdProduto(${idx}, 1)">+</button>
              </div>
            </td>
            <td style="text-align:right;"><span class="money">${formatBRL(subtotal)}</span></td>
            <td><button class="btn btn-danger" type="button" onclick="removerProdutoOS(${idx})">Remover</button></td>
          </tr>
        `;
      }).join('');
    }

    function alterarQtdProduto(index, delta) {
      if (!osEditandoId) return;
      const os = getOsById(osEditandoId);
      if (!os) return;

      const it = os.detalhes.itensVenda[index];
      if (!it) return;

      const produtos = getProdutos();
      const p = produtos.find(x => String(x.id) === String(it.produtoId));
      const estoque = normalizeProdutoEstoque(p);

      const novaQtd = Math.max(1, Number(it.qtd || 1) + delta);
      if (novaQtd > estoque) return toast(`Estoque insuficiente. Dispon√≠vel: ${estoque}`, 'warning');

      it.qtd = novaQtd;
      setOsById(os);
      renderOSProdutos();
      updateFinanceKPIs();
      renderListaOS();
    }

    function removerProdutoOS(index) {
      if (!osEditandoId) return;
      const os = getOsById(osEditandoId);
      if (!os) return;

      os.detalhes.itensVenda = os.detalhes.itensVenda.filter((_, i) => i !== index);
      setOsById(os);
      renderOSProdutos();
      updateFinanceKPIs();
      renderListaOS();
      toast('Produto removido.', 'warning');
    }

    // Servi√ßos
    function limparBuscaServico() { document.getElementById('buscarServico').value = ''; renderServicosBusca(); }
    function normalizeServicoValor(s) { return Number(s?.valor ?? s?.preco ?? 0); }

    function renderServicosBusca() {
      const tbody = document.getElementById('servicoBuscaTbody');
      if (!tbody) return;

      const term = (document.getElementById('buscarServico')?.value || '').toLowerCase().trim();
      const servicos = getServicos();

      let list = servicos;
      if (term) list = servicos.filter(s => `${s.nome||''} ${s.codigo||''}`.toLowerCase().includes(term));
      list = list.slice(0, 20);

      if (!list.length) {
        tbody.innerHTML = `<tr><td colspan="3"><div class="empty" style="padding:1.25rem;">Nenhum servi√ßo encontrado.</div></td></tr>`;
        return;
      }

      tbody.innerHTML = list.map(s => {
        const valor = normalizeServicoValor(s);
        return `
          <tr>
            <td>
              <div style="font-weight:900;">${escapeHTML(s.nome || 'Servi√ßo')}</div>
              <div class="hint">${escapeHTML(s.codigo || '')}</div>
            </td>
            <td style="text-align:right;"><span class="money">${formatBRL(valor)}</span></td>
            <td><button class="btn btn-primary" type="button" onclick="adicionarServicoOS('${escapeJS(String(s.id))}')">+ Anexar</button></td>
          </tr>
        `;
      }).join('');
    }

    function adicionarServicoOS(servicoId) {
      if (!osEditandoId) return;
      const os = getOsById(osEditandoId);
      if (!os) return;

      const s = getServicos().find(x => String(x.id) === String(servicoId));
      if (!s) return toast('Servi√ßo n√£o encontrado.', 'danger');

      const valor = normalizeServicoValor(s);
      const exists = os.detalhes.servicosAplicados.some(x => String(x.servicoId) === String(servicoId));
      if (exists) return toast('Servi√ßo j√° anexado.', 'warning');

      os.detalhes.servicosAplicados.push({ servicoId: String(s.id), nome: s.nome || 'Servi√ßo', valor });
      setOsById(os);

      renderOSServicos();
      updateFinanceKPIs();
      renderListaOS();
      toast('Servi√ßo anexado.', 'success');
    }

    function renderOSServicos() {
      const tbody = document.getElementById('osServicosTbody');
      const empty = document.getElementById('osServicosEmpty');
      if (!tbody || !empty) return;

      const os = osEditandoId ? getOsById(osEditandoId) : null;
      const list = os?.detalhes?.servicosAplicados || [];

      if (!list.length) {
        tbody.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      tbody.innerHTML = list.map((s, idx) => `
        <tr>
          <td><div style="font-weight:900;">${escapeHTML(s.nome)}</div></td>
          <td style="text-align:right;"><span class="money">${formatBRL(s.valor)}</span></td>
          <td><button class="btn btn-danger" type="button" onclick="removerServicoOS(${idx})">Remover</button></td>
        </tr>
      `).join('');
    }

    function removerServicoOS(index) {
      if (!osEditandoId) return;
      const os = getOsById(osEditandoId);
      if (!os) return;

      os.detalhes.servicosAplicados = os.detalhes.servicosAplicados.filter((_, i) => i !== index);
      setOsById(os);

      renderOSServicos();
      updateFinanceKPIs();
      renderListaOS();
      toast('Servi√ßo removido.', 'warning');
    }

    // Financeiro
    function updateFinanceKPIs() {
      if (!osEditandoId) return;
      const os = getOsById(osEditandoId);
      if (!os) return;

      os.detalhes.financeiro.desconto = Number(document.getElementById('editDesconto')?.value || os.detalhes.financeiro.desconto || 0);
      os.detalhes.financeiro.formaPagamento = document.getElementById('editFormaPagamento')?.value || os.detalhes.financeiro.formaPagamento || 'dinheiro';

      const totals = calcularTotaisOS(os);

      document.getElementById('kpiSubProdutos').textContent = formatBRL(totals.subtotalProdutos);
      document.getElementById('kpiSubServicos').textContent = formatBRL(totals.subtotalServicos);
      document.getElementById('kpiDesconto').textContent = formatBRL(totals.desconto);
      document.getElementById('kpiTotal').textContent = formatBRL(totals.total);

      const st = os.detalhes.financeiro.statusFaturamento || 'nao_faturada';
      if (st === 'faturada') {
        document.getElementById('pillFaturamento').textContent = 'Faturada';
        document.getElementById('hintFaturamento').textContent =
          `Faturada em ${formatDateTime(os.detalhes.financeiro.faturadoEm)} ‚Ä¢ ${os.detalhes.financeiro.formaPagamento || ''}`;
      } else if (st === 'pending') {
        document.getElementById('pillFaturamento').textContent = 'Aguardando pagamento';
        document.getElementById('hintFaturamento').textContent =
          os.detalhes.financeiro.cobrancaId ? `Cobran√ßa #${os.detalhes.financeiro.cobrancaId} criada.` : '';
      } else {
        document.getElementById('pillFaturamento').textContent = 'N√£o faturada';
        document.getElementById('hintFaturamento').textContent = '';
      }

      os.detalhes.financeiro.subtotalProdutos = totals.subtotalProdutos;
      os.detalhes.financeiro.subtotalServicos = totals.subtotalServicos;
      os.detalhes.financeiro.total = totals.total;
    }

    function validarEstoqueParaOS(os) {
      const produtos = getProdutos();
      for (const it of os.detalhes.itensVenda) {
        const p = produtos.find(x => String(x.id) === String(it.produtoId));
        if (!p) return { ok:false, msg:`Produto n√£o encontrado no estoque: ${it.nome}` };
        const estoque = normalizeProdutoEstoque(p);
        if (Number(it.qtd || 0) > estoque) return { ok:false, msg:`Estoque insuficiente: ${p.nome}. Necess√°rio ${it.qtd}, dispon√≠vel ${estoque}.` };
      }
      return { ok:true, msg:'' };
    }

    function baixarEstoqueOS(os) {
      const produtos = getProdutos();
      for (const it of os.detalhes.itensVenda) {
        const idx = produtos.findIndex(x => String(x.id) === String(it.produtoId));
        if (idx < 0) continue;
        const p = produtos[idx];
        const estoqueAtual = normalizeProdutoEstoque(p);
        const novo = Math.max(0, estoqueAtual - Number(it.qtd || 0));
        p.estoque_atual = novo;

        if (p.status !== 'inativo') {
          if (novo === 0) p.status = 'esgotado';
          else p.status = 'ativo';
        }

        produtos[idx] = p;
      }
      setProdutos(produtos);
    }

    // NOVO: Modal faturamento
    function abrirModalFaturamento() {
      if (!osEditandoId) return;
      const os = getOsById(osEditandoId);
      if (!os) return;

      const totals = calcularTotaisOS(os);
      const resumo = `
        <div><strong>${escapeHTML(os.numero)}</strong> ‚Ä¢ Cliente: <strong>${escapeHTML(os.cliente?.nome || '-')}</strong></div>
        <div style="margin-top:.25rem;">Total: <strong>${formatBRL(totals.total)}</strong> (Produtos: ${formatBRL(totals.subtotalProdutos)} ‚Ä¢ Servi√ßos: ${formatBRL(totals.subtotalServicos)} ‚Ä¢ Desc.: ${formatBRL(totals.desconto)})</div>
      `;
      document.getElementById('faturamentoResumo').innerHTML = resumo;

      document.getElementById('osOptPayNow').checked = true;
      document.getElementById('modalFaturamento').style.display = 'flex';
    }

    function fecharModalFaturamento() {
      const m = document.getElementById('modalFaturamento');
      m.style.animation = 'fadeOut .25s ease-out forwards';
      setTimeout(() => { m.style.display = 'none'; m.style.animation = ''; }, 250);
    }

    function getOSFulfillmentChoice() {
      const checked = document.querySelector('input[name="osFulfillment"]:checked');
      return checked ? checked.value : 'pay_now';
    }

    // Criar cobran√ßa padronizada para OS (Op√ß√£o 1)
    function createCobrancaFromOS(os) {
      const totals = calcularTotaisOS(os);

      const cobranca = {
        id: Date.now(),
        status: 'pending',
        paidAt: '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),

        origem: {
          tipo: 'os',
          refId: String(os.id),
          refNumero: String(os.numero)
        },

        cliente: {
          clienteId: String(os.cliente?.clienteId || ''),
          nome: String(os.cliente?.nome || '')
        },

        descricao: `Cobran√ßa OS ${os.numero}`,
        valorTotal: Number(totals.total.toFixed(2)),
        datas: {
          emissao: new Date().toISOString(),
          vencimento: new Date().toISOString().split('T')[0] // hoje (voc√™ pode ajustar depois)
        },

        parcelamento: { modo: 'avista', parcelas: 1 },
        parcelasDetalhe: [
          { numero: 1, vencimento: new Date().toISOString().split('T')[0], valor: Number(totals.total.toFixed(2)), status: 'aberta', pagamentos: [] }
        ],

        pagamentos: [],

        integracoes: {
          mercadopago: { preferenceId:'', paymentId:'', status:'', statusDetail:'', qrCode:'', ticketUrl:'' },
          whatsapp: { messageId:'', status:'', sentAt:'', deliveredAt:'' }
        }
      };

      const list = getCobrancas();
      list.unshift(cobranca);
      setCobrancas(list);

      return cobranca;
    }

    function confirmarFaturamento() {
      if (!osEditandoId) return;
      const os = getOsById(osEditandoId);
      if (!os) return;

      if (os.detalhes.financeiro.statusFaturamento === 'faturada') {
        toast('Esta OS j√° est√° faturada.', 'warning');
        return;
      }

      // Recalcula totais
      os.detalhes.financeiro.desconto = Number(document.getElementById('editDesconto')?.value || 0);
      os.detalhes.financeiro.formaPagamento = document.getElementById('editFormaPagamento')?.value || 'dinheiro';
      const totals = calcularTotaisOS(os);

      if (totals.total <= 0) {
        toast('Total zerado. Adicione produtos/servi√ßos antes.', 'warning');
        return;
      }

      const fulfillment = getOSFulfillmentChoice(); // pay_now | charge

      if (fulfillment === 'pay_now') {
        const estoqueOk = validarEstoqueParaOS(os);
        if (!estoqueOk.ok) { toast(estoqueOk.msg, 'danger'); return; }
        if (!confirm(`Pagar agora e faturar ${os.numero} no valor de ${formatBRL(totals.total)}? Isso dar√° baixa no estoque.`)) return;

        baixarEstoqueOS(os);

        os.detalhes.financeiro.statusFaturamento = 'faturada';
        os.detalhes.financeiro.faturadoEm = new Date().toISOString();
        os.detalhes.financeiro.subtotalProdutos = totals.subtotalProdutos;
        os.detalhes.financeiro.subtotalServicos = totals.subtotalServicos;
        os.detalhes.financeiro.total = totals.total;
        os.detalhes.financeiro.cobrancaId = null;

        setOsById(os);
        fecharModalFaturamento();
        renderListaOS();
        updateFinanceKPIs();
        toast('OS faturada e estoque atualizado!', 'success');
        return;
      }

      // charge: cria cobran√ßa e marca OS como pending
      if (!confirm(`Gerar cobran√ßa de ${formatBRL(totals.total)} para ${os.numero}? N√£o dar√° baixa no estoque agora.`)) return;

      const cobranca = createCobrancaFromOS(os);

      os.detalhes.financeiro.statusFaturamento = 'pending';
      os.detalhes.financeiro.faturadoEm = '';
      os.detalhes.financeiro.subtotalProdutos = totals.subtotalProdutos;
      os.detalhes.financeiro.subtotalServicos = totals.subtotalServicos;
      os.detalhes.financeiro.total = totals.total;
      os.detalhes.financeiro.cobrancaId = cobranca.id;

      setOsById(os);

      fecharModalFaturamento();
      renderListaOS();
      updateFinanceKPIs();

      toast(`Cobran√ßa criada (#${cobranca.id}). V√° em Cobran√ßa para receber.`, 'warning');

      // opcional: abrir cobran√ßa j√° filtrando por id
      // window.open(`cobranca.html?id=${cobranca.id}`, '_blank');
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('ano-atual').textContent = new Date().getFullYear();

      const isCollapsed = localStorage.getItem(LS.sidebarCollapsed) === 'true';
      if (isCollapsed) document.getElementById('mainLayout').classList.add('collapsed');

      renderTopUser();
      preencherSelectClientes();
      renderListaOS();

      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'b') { e.preventDefault(); toggleSidebar(); }
        if (e.key === 'Escape') { fecharModalFaturamento(); fecharModalEditar(); }
      });

      window.addEventListener('storage', (e) => {
        if (e.key === LS.clientes || e.key === LS.legacyClientes) preencherSelectClientes();
        if (e.key === LS.os || e.key === LS.legacyOs) renderListaOS();
        if (e.key === LS.config || e.key === LS.legacyConfig) {
          renderTopUser();
          if (osEditandoId) {
            const os = getOsById(osEditandoId);
            fillTiposEquipamentoSelect(os?.detalhes?.equipamento?.tipo || '');
            renderDinamicosSlot();
            applyDynamicValuesToUI(os);
            renderChecklistSlot();
          }
        }
        if (e.key === LS.produtos || e.key === LS.servicos) {
          if (osEditandoId) {
            const activePane = document.querySelector('.tab-pane.active')?.id;
            if (activePane === 'tab-produtos') renderProdutosBusca();
            if (activePane === 'tab-servicos') renderServicosBusca();
          }
        }
        if (e.key === LS.sidebarCollapsed) {
          const isCollapsed2 = localStorage.getItem(LS.sidebarCollapsed) === 'true';
          const layout2 = document.getElementById('mainLayout');
          if (!layout2) return;
          if (isCollapsed2) layout2.classList.add('collapsed');
          else layout2.classList.remove('collapsed');
        }
      });
    });

    // expor
    window.toggleSidebar = toggleSidebar;
    window.onClienteSelecionado = onClienteSelecionado;
    window.resetCriacao = resetCriacao;
    window.criarOSBasica = criarOSBasica;
    window.renderListaOS = renderListaOS;
    window.excluirOS = excluirOS;

    window.selectTab = selectTab;
    window.abrirModalEditar = abrirModalEditar;
    window.abrirModalFaturar = abrirModalFaturar;
    window.fecharModalEditar = fecharModalEditar;
    window.salvarDetalhesOS = salvarDetalhesOS;

    window.onModalTipoEquipamentoChange = onModalTipoEquipamentoChange;
    window.renderPreviewTermo = renderPreviewTermo;

    window.renderProdutosBusca = renderProdutosBusca;
    window.limparBuscaProduto = limparBuscaProduto;
    window.adicionarProdutoOS = adicionarProdutoOS;
    window.alterarQtdProduto = alterarQtdProduto;
    window.removerProdutoOS = removerProdutoOS;

    window.renderServicosBusca = renderServicosBusca;
    window.limparBuscaServico = limparBuscaServico;
    window.adicionarServicoOS = adicionarServicoOS;
    window.removerServicoOS = removerServicoOS;

    window.updateFinanceKPIs = updateFinanceKPIs;

    window.abrirModalFaturamento = abrirModalFaturamento;
    window.fecharModalFaturamento = fecharModalFaturamento;
    window.confirmarFaturamento = confirmarFaturamento;
  </script>
</body>
</html>